import{_ as e,r as t,o as i,c as p,a as c,b as n,d as o,w as l,e as s}from"./app-a9d52fc3.js";const r={},u=s(`<h2 id="i-连接副本集" tabindex="-1"><a class="header-anchor" href="#i-连接副本集" aria-hidden="true">#</a> Ⅰ. 连接副本集</h2><h4 id="_1-修复host" tabindex="-1"><a class="header-anchor" href="#_1-修复host" aria-hidden="true">#</a> 1. 修复host</h4><p>当时初始化副本集的时候，节点成员的host都是区域网ip，这是无法正常连接的。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>rs<span class="token punctuation">.</span><span class="token function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//查看member可知，节点的host都是区域网ip</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在使用Compass连接副本集时，会连接这些ip，本地ip肯定是不行的，会连接失败，因此需要修复这些host。</p><h5 id="_1-1-修改副本集节点的host" tabindex="-1"><a class="header-anchor" href="#_1-1-修改副本集节点的host" aria-hidden="true">#</a> 1.1 修改副本集节点的host</h5><p>实际上就是改一下 config，修改的代码如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>config <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
config<span class="token punctuation">.</span>members<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>host<span class="token operator">=</span><span class="token string">&quot;159.75.225.162:27017&quot;</span> <span class="token comment">//主节点</span>
config<span class="token punctuation">.</span>members<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>host<span class="token operator">=</span><span class="token string">&quot;159.75.225.162:27018&quot;</span> <span class="token comment">//从节点</span>
config<span class="token punctuation">.</span>members<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>host<span class="token operator">=</span><span class="token string">&quot;159.75.225.162:27019&quot;</span> <span class="token comment">//从节点</span>
rs<span class="token punctuation">.</span><span class="token function">reconfig</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">&quot;force&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-连接副本集" tabindex="-1"><a class="header-anchor" href="#_2-连接副本集" aria-hidden="true">#</a> 2. 连接副本集</h4>`,9),d=s(`<h2 id="ii-数据读写" tabindex="-1"><a class="header-anchor" href="#ii-数据读写" aria-hidden="true">#</a> Ⅱ. 数据读写</h2><h5 id="_1-主节点读写" tabindex="-1"><a class="header-anchor" href="#_1-主节点读写" aria-hidden="true">#</a> 1. 主节点读写</h5><p>登录主节点进行读写操作。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>myrs<span class="token punctuation">[</span>direct:primary<span class="token punctuation">]</span>article<span class="token operator">&gt;</span> use article  <span class="token comment"># 创建或选择article库</span>
<span class="token comment"># &#39;switched to db article&#39;</span>
db
articel <span class="token comment"># 显示当前数据库</span>
db.comment.insertOne<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment"># 插入一条数据</span>
    <span class="token string">&quot;articleid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;10000&quot;</span>,
    <span class="token string">&quot;content&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;that&#39;s good&quot;</span>,
    <span class="token string">&quot;userid&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1000&quot;</span>,
    <span class="token string">&quot;createdatetime&quot;</span><span class="token builtin class-name">:</span> new Date<span class="token punctuation">(</span><span class="token punctuation">)</span>,
    <span class="token string">&quot;likenum&quot;</span>:NumberInt<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>,
    <span class="token string">&quot;state&quot;</span>:null
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span> <span class="token comment"># 插入成功</span>
  acknowledged: true,
  insertedId: ObjectId<span class="token punctuation">(</span><span class="token string">&quot;64487fe22c64c9d9921960f8&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>插入数据成功后，在Compass中，确实可以看到数据库创建成功，数据也插入成功。</p><h4 id="_2-从节点读写" tabindex="-1"><a class="header-anchor" href="#_2-从节点读写" aria-hidden="true">#</a> 2. 从节点读写</h4><div class="hint-container danger"><p class="hint-container-title">警告</p><p>老的教程显示，从节点是没有读写权限的，需要使用slaveOk方法赋予权限。</p><p>实测，若以replicaSet的方式登录， 主节点和从节点的默认优先级是相同的，操作的一直都是主节点。</p><p>暂略。</p></div><h2 id="iii-主节点的选举" tabindex="-1"><a class="header-anchor" href="#iii-主节点的选举" aria-hidden="true">#</a> Ⅲ. 主节点的选举</h2><h4 id="_1-选举触发条件" tabindex="-1"><a class="header-anchor" href="#_1-选举触发条件" aria-hidden="true">#</a> 1. 选举触发条件</h4><p>MongoDB在副本集中，会自动进行主节点的选举，触发条件为：</p><ul><li>主节点故障</li><li>主节点网络不可达（默认心跳信息为10秒）</li><li>人工干预（rs.stepDown(600)）</li></ul><h4 id="_2-投票" tabindex="-1"><a class="header-anchor" href="#_2-投票" aria-hidden="true">#</a> 2. 投票</h4><p>每个节点都可以投票。<br> 选举规则是根据票数来决定谁获胜：</p><ul><li>票数最高：且获得了“大多数”成员的投票支持的节点获胜，大多数为 N/2 + 1。</li><li>票数相同，且都获得了“大多数”成员的投票支持的，数据新的节点获胜</li></ul><h4 id="_3-优先级" tabindex="-1"><a class="header-anchor" href="#_3-优先级" aria-hidden="true">#</a> 3. 优先级</h4><p>在获得票数的时候，优先级（priority）参数影响重大。</p><p>可以通过设置优先级（priority）来设置额外票数。优先级即权重，取值为0-1000，相当于可额外增加0-1000的票数，优先级的值越大，就越可能获得多数成员的投票（votes）数。<br> 指定较高的值可使成员更有资格成为主要成员，默认情况下，优先级的值是1。</p><h5 id="_3-1-查看优先级" tabindex="-1"><a class="header-anchor" href="#_3-1-查看优先级" aria-hidden="true">#</a> 3.1 查看优先级</h5><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>rs<span class="token punctuation">.</span><span class="token function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//返回的数据中members.priority就是优先级的值</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_3-2-修改优先级" tabindex="-1"><a class="header-anchor" href="#_3-2-修改优先级" aria-hidden="true">#</a> 3.2 修改优先级</h5><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>cfg<span class="token operator">=</span>rs<span class="token punctuation">.</span><span class="token function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//将配置导入变量</span>
cfg<span class="token punctuation">.</span>members<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>priority<span class="token operator">=</span><span class="token number">2</span> <span class="token comment">//修改0号成员的优先级</span>
rs<span class="token punctuation">.</span><span class="token function">reconfig</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span> <span class="token comment">//重新加载配置</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改优先级后，就会开始重新选举。</p><h2 id="iv-故障测试" tabindex="-1"><a class="header-anchor" href="#iv-故障测试" aria-hidden="true">#</a> Ⅳ. 故障测试</h2><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>TBD</p></div>`,24);function h(m,k){const a=t("RouterLink");return i(),p("div",null,[u,c("p",null,[n("详见："),o(a,{to:"/sql/mongodb/4.dev/4-1.Compass.html"},{default:l(()=>[n("Compass")]),_:1})]),d])}const b=e(r,[["render",h],["__file","2-3.操作副本集.html.vue"]]);export{b as default};
