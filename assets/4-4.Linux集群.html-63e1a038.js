import{_ as t,a as l,b as c,c as r,d as o}from"./4-3-5-3e051909.js";import{_ as d,r as p,o as u,c as m,a,b as e,d as s,e as i}from"./app-9f16a8fe.js";const h="/java-doc/img/sql/es/4-4-1.jpg",b={},v=i('<div class="hint-container tip"><p class="hint-container-title">提示</p><p>Linux上的Elasticsearch集群和单机的部署方式差不多，就多了一些集群方面的配置。这里和单机版的配置有大量重复内容。</p></div><div class="hint-container info"><p class="hint-container-title">集群环境</p><p>三台服务器组成集成环境，服务器都是在线的服务器，如下：</p><ul><li>tx-1：【159.75.225.162】 <strong>node1</strong>，<code>master</code>，个人腾讯云 <ul><li><code>CentOS Stream 9</code>：4核8G</li></ul></li><li>ali-2：【120.79.149.95】 <strong>node2</strong>，公司阿里云 <ul><li><code>CentOS Stream 9</code>：2核4G</li></ul></li><li>aws-3：【52.194.241.105】 <strong>node3</strong>，日本节点亚马逊云 <ul><li><code>Red Hat 9 Enterprise</code>：1核1G</li></ul></li></ul></div><h2 id="整体步骤" tabindex="-1"><a class="header-anchor" href="#整体步骤" aria-hidden="true">#</a> 整体步骤</h2><ul><li>安装：3个服务器都要进行 <ul><li>下载Elasticsearch 8.7.0</li><li>上传到服务器：/opt/soft-bar/</li><li>解压到：/opt/es/（此时ES软件目录为：<code>/opt/es/es-8.7.0/</code>）</li><li>补齐目录：<code>es-8.7.0/data</code>和<code>es-8.7.0/certs</code></li><li>创建es用户：创建一个专门的用户es，用来启动es服务</li></ul></li><li>证书：仅tx-1创建证书 <ul><li>签发ca证书</li><li>生成秘钥（节点证书）</li><li>将两个证书移动到<code>/es-8.7.0/config/certs/</code></li><li>签发HTTP证书</li><li>解压返回的HTTP证书，并移动到<code>/es-8.7.0/config/certs/</code></li></ul></li><li>证书复制：精tx-1的四个证书复制到另外两个服务器的certs目录</li><li>配置： <ul><li>配置tx-1：config/elasticsearch.yml</li><li>配置ali-2：config/elasticsearch.yml</li><li>配置aws-3：config/elasticsearch.yml</li></ul></li><li>启动 <ul><li>debug：有很多bug要提前解决</li><li>启动：常见bug解决后再进行依次启动三台服务器</li><li>访问：启动后就可以在浏览器端访问了</li></ul></li></ul><h2 id="安装" tabindex="-1"><a class="header-anchor" href="#安装" aria-hidden="true">#</a> 安装</h2><p>ES8需要Java17，不过ES8会默认会捆绑JDK，所以不配置Java环境也可以。</p><p>三台服务区都要同步进行以下步骤。</p><h4 id="_1-下载es" tabindex="-1"><a class="header-anchor" href="#_1-下载es" aria-hidden="true">#</a> 1. 下载ES</h4>',8),k={href:"https://www.elastic.co/cn/downloads/past-releases#elasticsearch",target:"_blank",rel:"noopener noreferrer"},f=i(`<p>可以在本地下载上传到服务器，也可以直接在服务器进行wget下载。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">wget</span> https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.7.0-linux-x86_64.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_2-上传安装包-规划目录" tabindex="-1"><a class="header-anchor" href="#_2-上传安装包-规划目录" aria-hidden="true">#</a> 2. 上传安装包，规划目录</h4><ul><li>上传目录：<code>/opt/soft-bar/</code>，该目录用来存放安装包</li><li>工作目录：<code>/opt/es/</code>：该目录存放所有ES相关的内容 <ul><li>解压目录：<code>/opt/es/es-8.7.0/</code></li><li>其他ES文件也都放在该目录下，包括Kibana</li></ul></li></ul><h5 id="_3-解压缩" tabindex="-1"><a class="header-anchor" href="#_3-解压缩" aria-hidden="true">#</a> 3. 解压缩</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /opt/soft-bar
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> elasticsearch-8.7.0-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /opt/es
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>解压后的目录结构：</p><figure><img src="`+t+`" alt="4-3-1" tabindex="0" loading="lazy"><figcaption>4-3-1</figcaption></figure><ul><li>bin：可执行脚本目录</li><li>config：配置目录</li><li>jdk：内置JDK</li><li>lib：内置类库</li><li>logs：日志目录</li><li>modules：模块目录</li><li>plugins：插件目录</li></ul><h5 id="_4-补齐目录" tabindex="-1"><a class="header-anchor" href="#_4-补齐目录" aria-hidden="true">#</a> 4. 补齐目录</h5><p>解压后的目录结构还缺一个数据文件目录和证书目录。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /opt/es/elasticsearch-8.7.0
<span class="token function">mkdir</span> data <span class="token comment"># 创建数据文件目录</span>
<span class="token function">mkdir</span> /config/certs <span class="token comment"># 创建证书目录</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-创建es用户" tabindex="-1"><a class="header-anchor" href="#_5-创建es用户" aria-hidden="true">#</a> 5. 创建es用户</h4><p>Elasticsearch 不能使用 root用户启动，因此要创建一个名为es的用户操作Elasticsearch。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">useradd</span> es <span class="token comment"># 创建用户</span>
<span class="token function">passwd</span> es <span class="token comment"># 设置密码，回车输入密码，这里暂密码暂定为es</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> es:es /opt/es/elasticsearch-8.7.0 <span class="token comment"># 修改文件拥有者</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ca证书" tabindex="-1"><a class="header-anchor" href="#ca证书" aria-hidden="true">#</a> CA证书</h2><p>证书是用来进行身份验证，防止请求被篡改的。不使用证书可能会报错。</p><p>ES通过内置的elasticsearch-certutil工具来生成证书。</p><h4 id="_1-ca模式。" tabindex="-1"><a class="header-anchor" href="#_1-ca模式。" aria-hidden="true">#</a> 1. CA模式。</h4><p>创建证书有四种模式：ca、cert、csr、http，我们这里采用CA模式</p><ul><li>CA模式生成新的证书颁发机构(ca)。默认情况下，它生成一个PKCS#12输出文件，其中保存CA证书和CA的私钥。</li><li>也可以指定–pem参数，则命令生成一个zip文件，其中包含PEM格式的证书和私钥。随后可以使用这些文件作为命令的cert模式的输入。</li><li>PKCS#12文件：一种交换数字证书的加密标准。通常用它来加密打包一个私钥及有关的 X.509 证书，产生的文件就是PKCS#12文件。</li></ul><h4 id="_2-ca证书" tabindex="-1"><a class="header-anchor" href="#_2-ca证书" aria-hidden="true">#</a> 2. CA证书</h4><ul><li>证书：用来证明受访问的服务身份信息。</li><li>签名：存在证书上的一个可信标识，代表该证书是经过认证的，因为假冒服务器也可以有证书。</li><li>CA证书：是公认可靠的CA(certificate authority)机构签发的证书</li></ul><figure><img src="`+l+'" alt="4-3-2" tabindex="0" loading="lazy"><figcaption>4-3-2</figcaption></figure><h4 id="_3-ca证书工作机理" tabindex="-1"><a class="header-anchor" href="#_3-ca证书工作机理" aria-hidden="true">#</a> 3. CA证书工作机理</h4><p>通过HTTPS请求的步骤来说明CA证书的工作机理</p><ul><li>浏览器发起https请求</li><li>服务器返回它的证书</li><li>浏览器通过CA的公钥对证书签名进行校验，检查证书是否有效</li><li>浏览器生成一个临时秘钥并用服务器的公钥对它加密，然后将其发送给服务器。</li><li>服务器用私钥解密，得到浏览器发送给它的秘钥， 然后用该秘钥对数据进行加密</li><li>浏览器得到加密数据，并用发给服务端的秘钥进行解密。</li></ul><figure><img src="'+c+`" alt="4-3-3" tabindex="0" loading="lazy"><figcaption>4-3-3</figcaption></figure><h4 id="_4-签发ca证书" tabindex="-1"><a class="header-anchor" href="#_4-签发ca证书" aria-hidden="true">#</a> 4. 签发ca证书</h4><p>需要用到内置的<code>elasticsearch-certutil ca</code> 命令，在 elasticsearch-8.7.0/bin目录中</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">su</span> es <span class="token comment"># 切换用户</span>
<span class="token builtin class-name">cd</span>  /opt/es/elasticsearch-8.7.0/bin <span class="token comment"># 进入bin目录</span>
./elasticsearch-certutil ca <span class="token comment"># 签发 ca 证书</span>

<span class="token comment"># 签发 ca 证书时有两次交互，直接回车即可</span>
<span class="token comment"># 第一次交互：设置文件名，回车采用默认名，默认文件在ES软件根目录中</span>
Please enter the desired output <span class="token function">file</span> <span class="token punctuation">[</span>elastic-stack-ca.p12<span class="token punctuation">]</span>: 
<span class="token comment"># 第二次交互：设置ca证书密码，直接回车将采用空密码，如果设置了要保存后，后续会用</span>
Enter password <span class="token keyword">for</span> elastic-stack-ca.p12 <span class="token builtin class-name">:</span>  <span class="token comment"># 设置密码</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>默认生成的证书位置：/opt/es/elasticsearch-8.7.0/elastic-stack-ca.p12</p><h4 id="_5-生成秘钥-节点证书" tabindex="-1"><a class="header-anchor" href="#_5-生成秘钥-节点证书" aria-hidden="true">#</a> 5. 生成秘钥（节点证书）</h4><p>使用ca证书生成秘钥，作发节点的证书，该证书用于节点之间的通信（集群多节点通信秘钥）</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 用户 和目录同上：elastic-stack-ca.p12就是刚刚生成的ca节点证书</span>
./elasticsearch-certutil cert <span class="token parameter variable">--ca</span> elastic-stack-ca.p12

<span class="token comment"># 签发过程有三次交互</span>
<span class="token comment"># 第一次交互：设输入ca证书的密码，之前没有设置密码就直接回车</span>
Enter password <span class="token keyword">for</span> CA <span class="token punctuation">(</span>elastic-stack-ca.p12<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> 
<span class="token comment"># 第二次交互：设置节点证书的文件名，直接回车采用默认的</span>
Please enter the desired output <span class="token function">file</span> <span class="token punctuation">[</span>elastic-certificates.p12<span class="token punctuation">]</span>: 
<span class="token comment"># 第三次交互：</span>
Enter password <span class="token keyword">for</span> elastic-certificates.p12 <span class="token builtin class-name">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>签发完成后，就在ES 根目录中生成了elastic-certificates.p12，它是单个PKCS#12密钥存储库，其中包括节点证书、节点密钥和CA证书。</p><h4 id="_6-移动证书" tabindex="-1"><a class="header-anchor" href="#_6-移动证书" aria-hidden="true">#</a> 6. 移动证书</h4><p>将生成的ca证书和节点证书移动到certs目录内</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">mv</span> elastic-* config/certs
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-签发http证书" tabindex="-1"><a class="header-anchor" href="#_7-签发http证书" aria-hidden="true">#</a> 7. 签发HTTP证书</h4><div class="hint-container danger"><p class="hint-container-title">注意</p><ul><li>使用使用 elasticsearch-certutil 工具自己生成的CA，签发的证书属于自认证证书，该证书浏览器是不不会信任的，需要手动让浏览器信任。可以选择使用第三方签发的受信任的证书。</li><li>签发证书时，要把集群中其他ip也添加进来。</li></ul></div><p>使用CA证书签发HTTP证书，以便可以使用HTTP REST API方式访问ES服务。</p><p>其他组件（例如 Kibana 或任何 Elastic 语言客户端）在连接到 ES服务 时会验证此证书。</p><p>生成证书的流程很复杂，交互很多，如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 用户 和目录同上</span>
./elasticsearch-certutil http

<span class="token comment"># 生成http证书的过程要进行以下10次交互</span>
<span class="token comment">##########################</span>

<span class="token comment"># 第1次: 是否生成证书签名请求</span>
Generate a CSR? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span> <span class="token comment"># n</span>

<span class="token comment"># 第2次: 是否要使用现有 CA</span>
Use an existing CA? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span> <span class="token comment"># y</span>

<span class="token comment"># 第3次: 指定ca证书的路径：以es软件/config为起始路径</span>
CA Path: <span class="token comment"># certs/elastic-stack-ca.p12 </span>

<span class="token comment"># 第4次: 输入CA证书的密码，之前创建ca证书时未设置，这里直接回车</span>
Password <span class="token keyword">for</span> elastic-stack-ca.p12: <span class="token comment"># 直接回车</span>

<span class="token comment"># 第5次: 证书的生效时间：默认是5y(5年)</span>
For how long should your certificate be valid? <span class="token punctuation">[</span>5y<span class="token punctuation">]</span> <span class="token comment"># 20y </span>

<span class="token comment"># 第6次: 是否为每个节点创建一个单独的证书：不需要，即使是集群也只需主节点创建证书</span>
Generate a certificate per node? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span> <span class="token comment"># n</span>

<span class="token comment"># 第7和8是用来配置DNS与证书绑定的：(域名-&gt;ip)：绑定证书</span>

<span class="token comment"># 第7次：输入链接到ES的主机名称（域名） # 如果是集群需要所如所有集群的主机名称</span>
<span class="token comment">## 如果没有DNS解析的主机名（域名），就需要使用本地进行hosts映射，或者直接用IP</span>
<span class="token number">159.75</span>.225.162 <span class="token comment"># 回车一次就可以输入一个名字，两次回车就输入完毕</span>
<span class="token number">120.79</span>.149.95 <span class="token comment"># ali-2</span>
<span class="token number">52.194</span>.241.105 <span class="token comment"># aws-3 没有被DNS解析的域名，直接用ip，访问的时候用ip访问</span>
Is this correct <span class="token punctuation">[</span>Y/n<span class="token punctuation">]</span> <span class="token comment">#y，确认名字输入是否正确</span>

<span class="token comment"># 第8次: 输入主机名(域名）解析的ip地址，需要提前进行DNS解析，或hosts映射</span>
<span class="token comment">## 如果是单节点集群，就要指定端口号</span>
<span class="token number">159.75</span>.225.162 <span class="token comment"># tx-1</span>
<span class="token number">120.79</span>.149.95 <span class="token comment"># ali-2</span>
<span class="token number">52.194</span>.241.105 <span class="token comment"># aws-3</span>
Is this correct <span class="token punctuation">[</span>Y/n<span class="token punctuation">]</span> <span class="token comment">#y，确认名字输入是否正确</span>


<span class="token comment"># 第9次: 是否对集群中的每个节点重复上述操作，不用</span>
Do you wish to change any of these options? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span> <span class="token comment"># n </span>

<span class="token comment"># 第10次: 是否给证书加密</span>
Provide a password <span class="token keyword">for</span> the <span class="token string">&quot;http.p12&quot;</span> file:  <span class="token comment"># 连续回车两次，不加密</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完成上述10个步骤，证书就生成好了，是一个压缩包，需要解压获取证书。<br> 证书位置：/opt/es/elasticsearch-8.7.0/elasticsearch-ssl-http.zip</p><h4 id="_7-解压并移动http证书" tabindex="-1"><a class="header-anchor" href="#_7-解压并移动http证书" aria-hidden="true">#</a> 7. 解压并移动http证书</h4><h5 id="_7-1-解压http证书" tabindex="-1"><a class="header-anchor" href="#_7-1-解压http证书" aria-hidden="true">#</a> 7.1 解压http证书</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span>  /opt/es/elasticsearch-8.7.0 
<span class="token function">unzip</span> elasticsearch-ssl-http.zip
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>解压后会在<code>/opt/es/elasticsearch-8.7.0/</code> 目录下产生两个信息目录</p><ul><li>elasticsearch：目录内有http.p12证书</li><li>kibana：目录内有elasticsearch-ca.pem证书</li></ul><h5 id="_7-2-移动证书" tabindex="-1"><a class="header-anchor" href="#_7-2-移动证书" aria-hidden="true">#</a> 7.2 移动证书</h5><p>将两个证书移动到certs目录中。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span>  /opt/es/elasticsearch-8.7.0 
<span class="token function">mv</span> elasticsearch/http.p12 kibana/elasticsearch-ca.pem config/certs
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> elasticsearch kibana <span class="token comment"># 删除之前生成的目录</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-复制证书" tabindex="-1"><a class="header-anchor" href="#_8-复制证书" aria-hidden="true">#</a> 8. 复制证书</h4><p>将tx-1生成的证书拷贝到另外两太服务器的certs目录中。<br><img src="`+h+'" alt="4-4-1" loading="lazy"></p><h2 id="配置文件" tabindex="-1"><a class="header-anchor" href="#配置文件" aria-hidden="true">#</a> 配置文件</h2><p>修改主配置文件：config/elasticsearch.yml，三台机器要分别修改。</p><p>注意修改的配置项说明：</p>',59),g={href:"http://cluster.name",target:"_blank",rel:"noopener noreferrer"},_={href:"http://node.name",target:"_blank",rel:"noopener noreferrer"},x=a("ul",null,[a("li",null,"如果不配置，就默认是当前主机的hostname")],-1),y=i("<li>IP <ul><li>network.host：允许访问es服务的IP地址。 <ul><li>默认：localhost，即：仅运行当前ip访问</li><li><code>0.0.0.0</code>：表示所有服务器都可以访问，需要配置安全信息</li></ul></li><li>http.port：ES服务的端口，默认是9200</li></ul></li><li>目录 <ul><li>path.data：索引数据的目录</li><li>path.logs：日志所在目录</li></ul></li>",2),w=a("li",null,[e("transport.port：TCP 监听端口，用于节点内部通信 "),a("ul",null,[a("li",null,"不用配置，默认就是9300")])],-1),I=a("li",null,[e("discovery.seed_hosts：被查询发现的其他节点的 "),a("ul",null,[a("li",null,"只需要配置其他节点的ip即可，默认会使用transport.port进行通信")])],-1),E=a("li",null,"开启一个全新的集群时，会有一个集群的引导步骤，这步骤用来确定哪些节点参与第一次的主节点选举",-1),S={href:"http://xn--node-475h.name",target:"_blank",rel:"noopener noreferrer"},M=a("li",null,"该配置仅在第一次启动集群有效，其他节点加入集群，或重启集群都是无效的，可以注释掉。",-1),C=i(`<h4 id="_1-tx-1-node-1" tabindex="-1"><a class="header-anchor" href="#_1-tx-1-node-1" aria-hidden="true">#</a> 1. tx-1：node-1</h4><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># ES文件和日志的目录</span>
<span class="token key atrule">path.data</span><span class="token punctuation">:</span> /opt/es/elasticsearch<span class="token punctuation">-</span>8.7.0/data
<span class="token key atrule">path.logs</span><span class="token punctuation">:</span> /opt/es/elasticsearch<span class="token punctuation">-</span>8.7.0/logs

<span class="token comment"># 生产时：不设置或localhost = 仅允许本机访问，更安全，</span>
<span class="token comment"># 开发时：0.0.0.0 = 允许网络上所有的主机访问ES服务</span>
<span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0 <span class="token comment"># 开发时设置成</span>

<span class="token comment"># 端口，默认就是9200，不设置也可以</span>
<span class="token key atrule">http.port</span><span class="token punctuation">:</span> <span class="token number">9200</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="启动es" tabindex="-1"><a class="header-anchor" href="#启动es" aria-hidden="true">#</a> 启动ES</h2><div class="hint-container tip"><p class="hint-container-title">提示</p><p>启动前，最好是先看下debug部分的内容。提前排错。</p></div><h4 id="_1-启动es" tabindex="-1"><a class="header-anchor" href="#_1-启动es" aria-hidden="true">#</a> 1. 启动ES</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 启动服务</span>
<span class="token builtin class-name">cd</span> /opt/es/elasticsearch-8.7.0/
bin/elasticsearch
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一次启动会显示如下内容</p><p>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</p><p>✅ Elasticsearch security features have been automatically configured!</p><p>✅ Authentication is enabled and cluster connections are encrypted.</p><p>Password for the elastic user (reset with <code>bin/elasticsearch-reset-password -u elastic</code>):</p><p><em>p1V7xKwWO8lgV62_aUfd</em></p><p>HTTP CA certificate SHA-256 fingerprint:</p><p><em>30b920bb03429973b605b035c144f7c51c7df327ec396f85e9db3ad82923157d</em></p><p>Configure Kibana to use this cluster:<br> Run Kibana and click the configuration link in the terminal when Kibana starts.<br> Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes):</p><p><em>eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTYuMC45OjkyMDAiXSwiZmdyIjoiMzBiOTIwYmIwMzQyOTk3M2I2MDViMDM1YzE0NGY3YzUxYzdkZjMyN2VjMzk2Zjg1ZTlkYjNhZDgyOTIzMTU3ZCIsImtleSI6ImczdTZFSWtCb24xMUUyVjlFTmJoOjFjemlfR2FDVFJtaWswQ1Y5TzJJX1EifQ==</em></p><p>Configure other nodes to join this cluster:<br> Copy the following enrollment token and start new Elasticsearch nodes with <code>bin/elasticsearch --enrollment-token &lt;token&gt;</code> (valid for the next 30 minutes):</p><p><code>eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTYuMC45OjkyMDAiXSwiZmdyIjoiMzBiOTIwYmIwMzQyOTk3M2I2MDViMDM1YzE0NGY3YzUxYzdkZjMyN2VjMzk2Zjg1ZTlkYjNhZDgyOTIzMTU3ZCIsImtleSI6ImdYdTZFSWtCb24xMUUyVjlFTmJlOm5xQVR4NWwxUUptdWN1endFeWg1alEifQ==</code></p><p>If you&#39;re running in Docker, copy the enrollment token and run:</p><p><code>docker run -e &quot;ENROLLMENT_TOKEN=&lt;token&gt;&quot; </code></p><p><code>docker.elastic.co/elasticsearch/elasticsearch:8.7.0</code><br> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━<br> 上面的内容只会在第一次启动时显示，注意保存里面的内容，尤其是账号和密码</p><ul><li>账号: elastic</li><li>密码: p1V7xKwWO8lgV62_aUfd</li></ul><h4 id="_2-守护进程" tabindex="-1"><a class="header-anchor" href="#_2-守护进程" aria-hidden="true">#</a> 2. 守护进程</h4><p>ES默认启动的方式是前台启动，第一次前台启动为了获取密码信息，之后可以选择守护进程的方式启动</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">su</span> es
<span class="token builtin class-name">cd</span> /opt/es/elasticsearch-8.7.0/

<span class="token comment"># 后台启动服务</span>
bin/elasticsearch <span class="token parameter variable">-d</span>

<span class="token comment"># 重启服务：重复启动命令就会重启</span>

<span class="token comment"># 停止ES运行：查询ES的pid，然后手动kill</span>
<span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> elastic 
<span class="token function">kill</span> <span class="token parameter variable">-9</span> pid
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="访问es" tabindex="-1"><a class="header-anchor" href="#访问es" aria-hidden="true">#</a> 访问ES</h2><h4 id="_1-浏览器访问" tabindex="-1"><a class="header-anchor" href="#_1-浏览器访问" aria-hidden="true">#</a> 1. 浏览器访问</h4><p>输入<code>https://ip或hostname:端口号/</code> 进行访问</p>`,28),T={href:"https://159.75.225.162:9200/",target:"_blank",rel:"noopener noreferrer"},j=i('<p>第一次访问要输入账号和密码，就是第一次启动ES时返回的账号密码（换一个客户端就要输一次密码）。</p><figure><img src="'+r+'" alt="4-3-4" tabindex="0" loading="lazy"><figcaption>4-3-4</figcaption></figure><p>登录后的页面：</p><figure><img src="'+o+`" alt="4-3-5" tabindex="0" loading="lazy"><figcaption>4-3-5</figcaption></figure><p>则表示服务正常启动，且能访问了。</p><h4 id="_2-postman访问es" tabindex="-1"><a class="header-anchor" href="#_2-postman访问es" aria-hidden="true">#</a> 2. postman访问ES</h4><p>因为开启了SSL，所以每个客户端都是要进行验证的，包括postman。</p><p>方式：需要在请求头上加token。</p><p>暂略，一般使用kibana检测ES</p><h2 id="debug" tabindex="-1"><a class="header-anchor" href="#debug" aria-hidden="true">#</a> debug</h2><p>一些启动时可能会出现的问题。</p><h4 id="_1-默认jvm内存过大" tabindex="-1"><a class="header-anchor" href="#_1-默认jvm内存过大" aria-hidden="true">#</a> 1. 默认JVM内存过大</h4><p>ES内置JVM的默认内存是4G。</p><p>如果Linux服务器剩余内存过小，就会直接卡死，可以按照优化章节的内容重新配置内存</p><p>ES 目录的 config/jvm.options文件是用来配置内存的。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment">################################################################</span>
<span class="token comment">## IMPORTANT: JVM heap size</span>
<span class="token comment">################################################################</span>
<span class="token comment">## -Xms4g</span>
<span class="token comment">## -Xmx4g</span>
<span class="token punctuation">-</span>Xms1g  <span class="token comment"># 初始启动大小</span>
<span class="token punctuation">-</span>Xmx1g  <span class="token comment"># 可分配的最大内置值</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-虚拟内存过小" tabindex="-1"><a class="header-anchor" href="#_2-虚拟内存过小" aria-hidden="true">#</a> 2. 虚拟内存过小</h4><p>报错：<code>max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</code>，虚拟内存过小，只有65530，至少需要262144</p><p>将虚拟内存修改层262144</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看当前虚拟内存</span>
<span class="token function">cat</span> /proc/sys/vm/max_map_count <span class="token comment"># 65530 </span>

<span class="token comment"># 修改虚拟内存</span>
<span class="token function">sudo</span> <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">vm.max_map_count</span><span class="token operator">=</span><span class="token number">262144</span> <span class="token comment"># vm.max_map_count=262144</span>

<span class="token comment"># 再次查看当前内存</span>
<span class="token function">cat</span> /proc/sys/vm/max_map_count <span class="token comment"># 262144</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PS :主机若进行了重启，就要重新修改虚拟内存</p><h4 id="_3-协议错误" tabindex="-1"><a class="header-anchor" href="#_3-协议错误" aria-hidden="true">#</a> 3. 协议错误</h4><ul><li>报错：received plaintext http traffic on an https chann<br> 配置了ssl，就要用https访问，而不是http</li></ul><h4 id="_4-忘记密码" tabindex="-1"><a class="header-anchor" href="#_4-忘记密码" aria-hidden="true">#</a> 4. 忘记密码</h4><p>第一次启动ES会返回密码信息，如果没有保存，可以采用指令重置密码</p><p>PS: 用户名默认是elastic</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /opt/es/elasticsearch-8.7.0/
bin/elasticsearch-reset-password <span class="token parameter variable">-u</span> elastic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-权限不够" tabindex="-1"><a class="header-anchor" href="#_5-权限不够" aria-hidden="true">#</a> 5. 权限不够</h4><p>Exception in thread &quot;main&quot; java.nio.file.AccessDeniedException: /opt/es/elasticsearch-8.7.0/config/elasticsearch.keystore</p><p>? Elasticsearch security features have been automatically configured!<br> ? Authentication is enabled and cluster connections are encrypted.</p><p>?? Password for the elastic user (reset with <code>bin/elasticsearch-reset-password -u elastic</code>):<br> bPd3IljvLdDJC*8WHrvG</p><p>?? HTTP CA certificate SHA-256 fingerprint:<br> f4ca10071e90593a4acf08c5b0260e964adacd809ee195d83ecb37f2ef6fd901</p><p>?? Configure Kibana to use this cluster:<br> ? Run Kibana and click the configuration link in the terminal when Kibana starts.<br> ? Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes):<br> eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTYuMC45OjkyMDAiXSwiZmdyIjoiZjRjYTEwMDcxZTkwNTkzYTRhY2YwOGM1YjAyNjBlOTY0YWRhY2Q4MDllZTE5NWQ4M2VjYjM3ZjJlZjZmZDkwMSIsImtleSI6ImlabTZGNGtCTWRYOFlPZWVWS2hmOlkwY3VYaTk0UTZPZUN5ZEQ1cnJkWHcifQ==</p><p>?? Configure other nodes to join this cluster:<br> ? On this node:<br> ? Create an enrollment token with <code>bin/elasticsearch-create-enrollment-token -s node</code>.<br> ? Uncomment the transport.host setting at the end of config/elasticsearch.yml.<br> ? Restart Elasticsearch.<br> ? On other nodes:<br> ? Start Elasticsearch with <code>bin/elasticsearch --enrollment-token &lt;token&gt;</code>, using the enrollment token that you generated.</p><p>✅ Elasticsearch security features have been automatically configured!<br> ✅ Authentication is enabled and cluster connections are encrypted.</p><p>ℹ️ Password for the elastic user (reset with <code>bin/elasticsearch-reset-password -u elastic</code>):<br> =4NXyZl9prIzWN2y0rDg</p><p>ℹ️ HTTP CA certificate SHA-256 fingerprint:<br> d3f3907c1945bbfd103e3db7fd04e237b1e94ed67c239171c4f2a9a0ab4d81f9</p><p>ℹ️ Configure Kibana to use this cluster:<br> • Run Kibana and click the configuration link in the terminal when Kibana starts.<br> • Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes):<br> eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTkuMjQuMjU0OjkyMDAiXSwiZmdyIjoiZDNmMzkwN2MxOTQ1YmJmZDEwM2UzZGI3ZmQwNGUyMzdiMWU5NGVkNjdjMjM5MTcxYzRmMmE5YTBhYjRkODFmOSIsImtleSI6Imw3ektGNGtCMDIzOHI0aVlWd0pCOkczcFFER2JLVENHM1VGbG9EMHpkRmcifQ==</p><p>ℹ️ Configure other nodes to join this cluster:<br> • On this node:<br> ⁃ Create an enrollment token with <code>bin/elasticsearch-create-enrollment-token -s node</code>.<br> ⁃ Uncomment the transport.host setting at the end of config/elasticsearch.yml.<br> ⁃ Restart Elasticsearch.<br> • On other nodes:<br> ⁃ Start Elasticsearch with <code>bin/elasticsearch --enrollment-token &lt;token&gt;</code>, using the enrollment token that you generated.</p>`,39);function N(z,A){const n=p("ExternalLinkIcon");return u(),m("div",null,[v,a("ul",null,[a("li",null,[e("下载地址："),a("a",k,[e("LINUX_X86_64"),s(n)])])]),f,a("ul",null,[a("li",null,[e("名称 "),a("ul",null,[a("li",null,[a("a",g,[e("cluster.name"),s(n)]),e("：集群名称，节点之间要保持一致")]),a("li",null,[a("a",_,[e("node.name"),s(n)]),e("：节点名称，集群内要唯一 "),x])])]),y,a("li",null,[e("集群 "),a("ul",null,[w,I,a("li",null,[e("cluster.initial_master_nodes：初始主节点 "),a("ul",null,[E,a("li",null,[e("做法：在第一个启动的节点处配置，配置是当前节点的hostname（"),a("a",S,[e("或node.name"),s(n)]),e("）")]),M])])])])]),C,a("p",null,[e("当前配置的URL： "),a("a",T,[e("https://159.75.225.162:9200/"),s(n)]),e(" （没有主机映射，就直接用ip访问了）")]),j])}const Y=d(b,[["render",N],["__file","4-4.Linux集群.html.vue"]]);export{Y as default};
