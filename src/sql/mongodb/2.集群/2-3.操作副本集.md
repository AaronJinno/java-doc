---
title: 2-3. 操作副本集
date: 2023-04-26
---

## 连接副本集
#### 1. 修复host
当时初始化副本集的时候，节点成员的host都是区域网ip，这是无法正常连接的。
```js
rs.conf()
//查看member可知，节点的host都是区域网ip
```

在使用Compass连接副本集时，会连接这些ip，本地ip肯定是不行的，会连接失败，因此需要修复这些host。

##### 1.1 修改副本集节点的host
实际上就是改一下 config，修改的代码如下：

```js
config = rs.conf()
config.members[0].host="159.75.225.162:27017" //主节点
config.members[1].host="159.75.225.162:27018" //从节点
config.members[2].host="159.75.225.162:27019" //从节点
rs.reconfig(config,{"force":true})
```
#### 2. 连接副本集
详见：[Compass](/sql/mongodb/4.dev/4-1.Compass.md)



## 数据读写
##### 1. 主节点读写
登录主节点进行读写操作。
```shell
myrs[direct:primary]article> use article  # 创建或选择article库
# 'switched to db article'
db
articel # 显示当前数据库
db.comment.insertOne({ # 插入一条数据
    "articleid":"10000",
    "content": "that's good",
    "userid":"1000",
    "createdatetime": new Date(),
    "likenum":NumberInt(10),
    "state":null
})

{ # 插入成功
  acknowledged: true,
  insertedId: ObjectId("64487fe22c64c9d9921960f8")
}
```
插入数据成功后，在Compass中，确实可以看到数据库创建成功，数据也插入成功。

#### 2. 从节点读写
登录副本从节点进行读写
:::danger
登录时依然要勾选：Direct Connection
:::

在Compass登录成功后是无法查看Databases的，页面是空白的。

![2-3-1](/img/sql/mongodb/2-3-1.png)

在shell中可以查看数据库，和集合信息，但是无法读取集合内的数据。
```shell
show dbs  # 可以正常查看数据库列表
use article # 可以正常选择数据库
myrs [direct: secondary] article >show collections # 可以查看集合
# comment ，该库中有个comment集合
myrs [direct: secondary] article >db.comment.find() # 读取集合中的数据
# 以下是报错信息
MongoServerError: not primary and secondaryOk=false -
consider using db.getMongo().setReadPref() or readPreference 
in the connection string

```

当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行。  
因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置。

#####  1.3 设置读操作权限：
将从节点设置为奴隶节点，允许在从成员上运行读的操作。
```shell
r
```


#### 2. 主节点的选举


#### 3. 故障测试

#### 4. Compass连接副本集

#### 5. Java连接副本集