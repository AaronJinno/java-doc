---
title: 4-4. Linux集群
date: 2023-06-28
---
:::tip
Linux上的Elasticsearch集群和单机的部署方式差不多，就多了一些集群方面的配置。这里和单机版的配置有大量重复内容。
:::

:::info 集群环境
三台服务器组成集成环境，服务器都是在线的服务器，如下：
- tx-1：【159.75.225.162】 **node1**，`master`，个人腾讯云
    - `CentOS Stream 9`：4核8G
- ali-2：【120.79.149.95】 **node2**，公司阿里云
    - `CentOS Stream 9`：2核4G
- aws-3：【52.194.241.105】 **node3**，日本节点亚马逊云
    - `Red Hat 9 Enterprise`：1核1G
:::

## 整体步骤
- 安装：3个服务器都要进行
    - 下载Elasticsearch 8.7.0
    - 上传到服务器：/opt/soft-bar/
    - 解压到：/opt/es/（此时ES软件目录为：`/opt/es/es-8.7.0/`）
    - 补齐目录：`es-8.7.0/data`和`es-8.7.0/certs`
    - 创建es用户：创建一个专门的用户es，用来启动es服务
- 证书：仅tx-1创建证书
    - 签发ca证书
    - 生成秘钥（节点证书）
    - 将两个证书移动到`/es-8.7.0/config/certs/`
    - 签发HTTP证书
    - 解压返回的HTTP证书，并移动到`/es-8.7.0/config/certs/`
- 证书复制：精tx-1的四个证书复制到另外两个服务器的certs目录
- 配置：
    - 配置tx-1：config/elasticsearch.yml
    - 配置ali-2：config/elasticsearch.yml
    - 配置aws-3：config/elasticsearch.yml
- 启动
    - debug：有很多bug要提前解决
    - 启动：常见bug解决后再进行依次启动三台服务器
    - 访问：启动后就可以在浏览器端访问了


## 安装
ES8需要Java17，不过ES8会默认会捆绑JDK，所以不配置Java环境也可以。

三台服务区都要同步进行以下步骤。

#### 1. 下载ES
- 下载地址：[LINUX_X86_64](https://www.elastic.co/cn/downloads/past-releases#elasticsearch)

可以在本地下载上传到服务器，也可以直接在服务器进行wget下载。
```shell
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.7.0-linux-x86_64.tar.gz
```

#### 2. 上传安装包，规划目录
- 上传目录：`/opt/soft-bar/`，该目录用来存放安装包
- 工作目录：`/opt/es/`：该目录存放所有ES相关的内容
    - 解压目录：`/opt/es/es-8.7.0/`
    - 其他ES文件也都放在该目录下，包括Kibana

##### 3. 解压缩
```shell
cd /opt/soft-bar
tar -zxvf elasticsearch-8.7.0-linux-x86_64.tar.gz -C /opt/es
```

解压后的目录结构：

![4-3-1](/img/sql/es/4-3-1.jpg)

- bin：可执行脚本目录
- config：配置目录
- jdk：内置JDK
- lib：内置类库
- logs：日志目录
- modules：模块目录
- plugins：插件目录

##### 4. 补齐目录
解压后的目录结构还缺一个数据文件目录和证书目录。
```shell
cd /opt/es/elasticsearch-8.7.0
mkdir data # 创建数据文件目录
mkdir /config/certs # 创建证书目录
```

#### 5. 创建es用户
Elasticsearch 不能使用 root用户启动，因此要创建一个名为es的用户操作Elasticsearch。
```shell
useradd es # 创建用户
passwd es # 设置密码，回车输入密码，这里暂密码暂定为es
chown -R es:es /opt/es/elasticsearch-8.7.0 # 修改文件拥有者
```


## CA证书
证书是用来进行身份验证，防止请求被篡改的。不使用证书可能会报错。

ES通过内置的elasticsearch-certutil工具来生成证书。

#### 1. CA模式。
创建证书有四种模式：ca、cert、csr、http，我们这里采用CA模式
- CA模式生成新的证书颁发机构(ca)。默认情况下，它生成一个PKCS#12输出文件，其中保存CA证书和CA的私钥。
- 也可以指定–pem参数，则命令生成一个zip文件，其中包含PEM格式的证书和私钥。随后可以使用这些文件作为命令的cert模式的输入。
- PKCS#12文件：一种交换数字证书的加密标准。通常用它来加密打包一个私钥及有关的 X.509 证书，产生的文件就是PKCS#12文件。


#### 2. CA证书
- 证书：用来证明受访问的服务身份信息。
- 签名：存在证书上的一个可信标识，代表该证书是经过认证的，因为假冒服务器也可以有证书。
- CA证书：是公认可靠的CA(certificate authority)机构签发的证书

![4-3-2](/img/sql/es/4-3-2.jpg)

#### 3. CA证书工作机理
通过HTTPS请求的步骤来说明CA证书的工作机理
- 浏览器发起https请求
- 服务器返回它的证书
- 浏览器通过CA的公钥对证书签名进行校验，检查证书是否有效
- 浏览器生成一个临时秘钥并用服务器的公钥对它加密，然后将其发送给服务器。
- 服务器用私钥解密，得到浏览器发送给它的秘钥， 然后用该秘钥对数据进行加密
- 浏览器得到加密数据，并用发给服务端的秘钥进行解密。

![4-3-3](/img/sql/es/4-3-3.jpg)


#### 4. 签发ca证书
需要用到内置的`elasticsearch-certutil ca` 命令，在 elasticsearch-8.7.0/bin目录中

```shell
su es # 切换用户
cd  /opt/es/elasticsearch-8.7.0/bin # 进入bin目录
./elasticsearch-certutil ca # 签发 ca 证书

# 签发 ca 证书时有两次交互，直接回车即可
# 第一次交互：设置文件名，回车采用默认名，默认文件在ES软件根目录中
Please enter the desired output file [elastic-stack-ca.p12]: 
# 第二次交互：设置ca证书密码，直接回车将采用空密码，如果设置了要保存后，后续会用
Enter password for elastic-stack-ca.p12 :  # 设置密码
```
默认生成的证书位置：/opt/es/elasticsearch-8.7.0/elastic-stack-ca.p12


#### 5. 生成秘钥（节点证书）
使用ca证书生成秘钥，作发节点的证书，该证书用于节点之间的通信（集群多节点通信秘钥）

```shell
# 用户 和目录同上：elastic-stack-ca.p12就是刚刚生成的ca节点证书
./elasticsearch-certutil cert --ca elastic-stack-ca.p12

# 签发过程有三次交互
# 第一次交互：设输入ca证书的密码，之前没有设置密码就直接回车
Enter password for CA (elastic-stack-ca.p12) : 
# 第二次交互：设置节点证书的文件名，直接回车采用默认的
Please enter the desired output file [elastic-certificates.p12]: 
# 第三次交互：
Enter password for elastic-certificates.p12 :
```
签发完成后，就在ES 根目录中生成了elastic-certificates.p12，它是单个PKCS#12密钥存储库，其中包括节点证书、节点密钥和CA证书。


#### 6. 移动证书
将生成的ca证书和节点证书移动到certs目录内

```shell
cd ..
mv elastic-* config/certs
```

#### 7. 签发HTTP证书
:::danger 注意
- 使用使用 elasticsearch-certutil 工具自己生成的CA，签发的证书属于自认证证书，该证书浏览器是不不会信任的，需要手动让浏览器信任。可以选择使用第三方签发的受信任的证书。
- 签发证书时，要把集群中其他ip也添加进来。
:::
使用CA证书签发HTTP证书，以便可以使用HTTP REST API方式访问ES服务。

其他组件（例如 Kibana 或任何 Elastic 语言客户端）在连接到 ES服务 时会验证此证书。

生成证书的流程很复杂，交互很多，如下：
```shell
# 用户 和目录同上
./elasticsearch-certutil http

# 生成http证书的过程要进行以下10次交互
##########################

# 第1次: 是否生成证书签名请求
Generate a CSR? [y/N] # n

# 第2次: 是否要使用现有 CA
Use an existing CA? [y/N] # y

# 第3次: 指定ca证书的路径：以es软件/config为起始路径
CA Path: # certs/elastic-stack-ca.p12 

# 第4次: 输入CA证书的密码，之前创建ca证书时未设置，这里直接回车
Password for elastic-stack-ca.p12: # 直接回车

# 第5次: 证书的生效时间：默认是5y(5年)
For how long should your certificate be valid? [5y] # 20y 

# 第6次: 是否为每个节点创建一个单独的证书：不需要，即使是集群也只需主节点创建证书
Generate a certificate per node? [y/N] # n

# 第7和8是用来配置DNS与证书绑定的：(域名->ip)：绑定证书

# 第7次：输入链接到ES的主机名称（域名） # 如果是集群需要所如所有集群的主机名称
## 如果没有DNS解析的主机名（域名），就需要使用本地进行hosts映射，或者直接用IP
159.75.225.162 # 回车一次就可以输入一个名字，两次回车就输入完毕
120.79.149.95 # ali-2
52.194.241.105 # aws-3 没有被DNS解析的域名，直接用ip，访问的时候用ip访问
Is this correct [Y/n] #y，确认名字输入是否正确

# 第8次: 输入主机名(域名）解析的ip地址，需要提前进行DNS解析，或hosts映射
## 如果是单节点集群，就要指定端口号
159.75.225.162 # tx-1
120.79.149.95 # ali-2
52.194.241.105 # aws-3
Is this correct [Y/n] #y，确认名字输入是否正确


# 第9次: 是否对集群中的每个节点重复上述操作，不用
Do you wish to change any of these options? [y/N] # n 

# 第10次: 是否给证书加密
Provide a password for the "http.p12" file:  # 连续回车两次，不加密
```

完成上述10个步骤，证书就生成好了，是一个压缩包，需要解压获取证书。
证书位置：/opt/es/elasticsearch-8.7.0/elasticsearch-ssl-http.zip

#### 7. 解压并移动http证书
##### 7.1 解压http证书
```shell
cd  /opt/es/elasticsearch-8.7.0 
unzip elasticsearch-ssl-http.zip
```
解压后会在`/opt/es/elasticsearch-8.7.0/` 目录下产生两个信息目录
- elasticsearch：目录内有http.p12证书
- kibana：目录内有elasticsearch-ca.pem证书


##### 7.2 移动证书
将两个证书移动到certs目录中。
```shell
cd  /opt/es/elasticsearch-8.7.0 
mv elasticsearch/http.p12 kibana/elasticsearch-ca.pem config/certs
rm -rf elasticsearch kibana # 删除之前生成的目录
```
#### 8. 复制证书
将tx-1生成的证书拷贝到另外两太服务器的certs目录中。
![4-4-1](/img/sql/es/4-4-1.jpg)


## 配置文件
修改主配置文件：config/elasticsearch.yml，三台机器要分别修改。

注意修改的配置项说明：
- 名称
    - cluster.name：集群名称，节点之间要保持一致
    - node.name：节点名称，集群内要唯一
        - 如果不配置，就默认是当前主机的hostname
- IP
    - network.host：允许访问es服务的IP地址。
        - 默认：localhost，即：仅运行当前ip访问
        - `0.0.0.0`：表示所有服务器都可以访问，需要配置安全信息
    - http.port：ES服务的端口，默认是9200
- 目录
    - path.data：索引数据的目录
    - path.logs：日志所在目录
- 集群
    - transport.port：TCP 监听端口，用于节点内部通信
        - 不用配置，默认就是9300
    - discovery.seed_hosts：被查询发现的其他节点的
        - 只需要配置其他节点的ip即可，默认会使用transport.port进行通信
    - cluster.initial_master_nodes：初始主节点
        - 开启一个全新的集群时，会有一个集群的引导步骤，这步骤用来确定哪些节点参与第一次的主节点选举
        - 做法：在第一个启动的节点处配置，配置是当前节点的hostname（或node.name）
        - 该配置仅在第一次启动集群有效，其他节点加入集群，或重启集群都是无效的，可以注释掉。

#### 1. tx-1：node-1
```yml
# ES文件和日志的目录
path.data: /opt/es/elasticsearch-8.7.0/data
path.logs: /opt/es/elasticsearch-8.7.0/logs

# 生产时：不设置或localhost = 仅允许本机访问，更安全，
# 开发时：0.0.0.0 = 允许网络上所有的主机访问ES服务
network.host: 0.0.0.0 # 开发时设置成

# 端口，默认就是9200，不设置也可以
http.port: 9200
```


## 启动ES
:::tip
启动前，最好是先看下debug部分的内容。提前排错。
:::

#### 1. 启动ES
```shell
# 启动服务
cd /opt/es/elasticsearch-8.7.0/
bin/elasticsearch
```

第一次启动会显示如下内容

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

:white_check_mark: Elasticsearch security features have been automatically configured!

:white_check_mark: Authentication is enabled and cluster connections are encrypted.

Password for the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`): 

*p1V7xKwWO8lgV62_aUfd*

HTTP CA certificate SHA-256 fingerprint:

*30b920bb03429973b605b035c144f7c51c7df327ec396f85e9db3ad82923157d*

Configure Kibana to use this cluster:  
Run Kibana and click the configuration link in the terminal when Kibana starts.  
Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes):

*eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTYuMC45OjkyMDAiXSwiZmdyIjoiMzBiOTIwYmIwMzQyOTk3M2I2MDViMDM1YzE0NGY3YzUxYzdkZjMyN2VjMzk2Zjg1ZTlkYjNhZDgyOTIzMTU3ZCIsImtleSI6ImczdTZFSWtCb24xMUUyVjlFTmJoOjFjemlfR2FDVFJtaWswQ1Y5TzJJX1EifQ==*

Configure other nodes to join this cluster:  
Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token <token>` (valid for the next 30 minutes):

`eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTYuMC45OjkyMDAiXSwiZmdyIjoiMzBiOTIwYmIwMzQyOTk3M2I2MDViMDM1YzE0NGY3YzUxYzdkZjMyN2VjMzk2Zjg1ZTlkYjNhZDgyOTIzMTU3ZCIsImtleSI6ImdYdTZFSWtCb24xMUUyVjlFTmJlOm5xQVR4NWwxUUptdWN1endFeWg1alEifQ==`


If you're running in Docker, copy the enrollment token and run:

`docker run -e "ENROLLMENT_TOKEN=<token>" `

`docker.elastic.co/elasticsearch/elasticsearch:8.7.0`
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
上面的内容只会在第一次启动时显示，注意保存里面的内容，尤其是账号和密码
- 账号: elastic
- 密码: p1V7xKwWO8lgV62_aUfd


#### 2. 守护进程
ES默认启动的方式是前台启动，第一次前台启动为了获取密码信息，之后可以选择守护进程的方式启动
```shell
su es
cd /opt/es/elasticsearch-8.7.0/

# 后台启动服务
bin/elasticsearch -d

# 重启服务：重复启动命令就会重启

# 停止ES运行：查询ES的pid，然后手动kill
ps -ef | grep elastic 
kill -9 pid
```
## 访问ES
#### 1. 浏览器访问
输入`https://ip或hostname:端口号/` 进行访问

当前配置的URL： https://159.75.225.162:9200/ （没有主机映射，就直接用ip访问了）

第一次访问要输入账号和密码，就是第一次启动ES时返回的账号密码（换一个客户端就要输一次密码）。

![4-3-4](/img/sql/es/4-3-4.jpg)

登录后的页面：

![4-3-5](/img/sql/es/4-3-5.jpg)

则表示服务正常启动，且能访问了。

#### 2. postman访问ES
因为开启了SSL，所以每个客户端都是要进行验证的，包括postman。

方式：需要在请求头上加token。

暂略，一般使用kibana检测ES





## debug
一些启动时可能会出现的问题。
#### 1. 默认JVM内存过大
ES内置JVM的默认内存是4G。

如果Linux服务器剩余内存过小，就会直接卡死，可以按照优化章节的内容重新配置内存

ES 目录的 config/jvm.options文件是用来配置内存的。
```yaml
################################################################
## IMPORTANT: JVM heap size
################################################################
## -Xms4g
## -Xmx4g
-Xms1g  # 初始启动大小
-Xmx1g  # 可分配的最大内置值
```

#### 2. 虚拟内存过小 
报错：`max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]`，虚拟内存过小，只有65530，至少需要262144

将虚拟内存修改层262144
```shell
# 查看当前虚拟内存
cat /proc/sys/vm/max_map_count # 65530 

# 修改虚拟内存
sudo sysctl -w vm.max_map_count=262144 # vm.max_map_count=262144

# 再次查看当前内存
cat /proc/sys/vm/max_map_count # 262144
```

PS :主机若进行了重启，就要重新修改虚拟内存

#### 3. 协议错误
- 报错：received plaintext http traffic on an https chann
配置了ssl，就要用https访问，而不是http


#### 4. 忘记密码
第一次启动ES会返回密码信息，如果没有保存，可以采用指令重置密码

PS: 用户名默认是elastic
```shell
cd /opt/es/elasticsearch-8.7.0/
bin/elasticsearch-reset-password -u elastic
```
#### 5. 权限不够
Exception in thread "main" java.nio.file.AccessDeniedException: /opt/es/elasticsearch-8.7.0/config/elasticsearch.keystore





? Elasticsearch security features have been automatically configured!
? Authentication is enabled and cluster connections are encrypted.

??  Password for the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`):
  bPd3IljvLdDJC*8WHrvG

??  HTTP CA certificate SHA-256 fingerprint:
  f4ca10071e90593a4acf08c5b0260e964adacd809ee195d83ecb37f2ef6fd901

??  Configure Kibana to use this cluster:
? Run Kibana and click the configuration link in the terminal when Kibana starts.
? Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes):
  eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTYuMC45OjkyMDAiXSwiZmdyIjoiZjRjYTEwMDcxZTkwNTkzYTRhY2YwOGM1YjAyNjBlOTY0YWRhY2Q4MDllZTE5NWQ4M2VjYjM3ZjJlZjZmZDkwMSIsImtleSI6ImlabTZGNGtCTWRYOFlPZWVWS2hmOlkwY3VYaTk0UTZPZUN5ZEQ1cnJkWHcifQ==

??  Configure other nodes to join this cluster:
? On this node:
  ? Create an enrollment token with `bin/elasticsearch-create-enrollment-token -s node`.
  ? Uncomment the transport.host setting at the end of config/elasticsearch.yml.
  ? Restart Elasticsearch.
? On other nodes:
  ? Start Elasticsearch with `bin/elasticsearch --enrollment-token <token>`, using the enrollment token that you generated.







✅ Elasticsearch security features have been automatically configured!
✅ Authentication is enabled and cluster connections are encrypted.

ℹ️  Password for the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`):
  =4NXyZl9prIzWN2y0rDg

ℹ️  HTTP CA certificate SHA-256 fingerprint:
  d3f3907c1945bbfd103e3db7fd04e237b1e94ed67c239171c4f2a9a0ab4d81f9

ℹ️  Configure Kibana to use this cluster:
• Run Kibana and click the configuration link in the terminal when Kibana starts.
• Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes):
  eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTkuMjQuMjU0OjkyMDAiXSwiZmdyIjoiZDNmMzkwN2MxOTQ1YmJmZDEwM2UzZGI3ZmQwNGUyMzdiMWU5NGVkNjdjMjM5MTcxYzRmMmE5YTBhYjRkODFmOSIsImtleSI6Imw3ektGNGtCMDIzOHI0aVlWd0pCOkczcFFER2JLVENHM1VGbG9EMHpkRmcifQ==

ℹ️  Configure other nodes to join this cluster:
• On this node:
  ⁃ Create an enrollment token with `bin/elasticsearch-create-enrollment-token -s node`.
  ⁃ Uncomment the transport.host setting at the end of config/elasticsearch.yml.
  ⁃ Restart Elasticsearch.
• On other nodes:
  ⁃ Start Elasticsearch with `bin/elasticsearch --enrollment-token <token>`, using the enrollment token that you generated.
