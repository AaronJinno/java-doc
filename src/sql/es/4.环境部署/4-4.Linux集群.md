---
title: 4-4. Linux集群
date: 2023-06-28
---
:::tip
Linux上的Elasticsearch集群和单机有很多重复的步骤，这里进行了重复的列出，方便查询。

小技巧：所有节点可以先跑通单节点，验证了主机的可靠性后再配置集群，以免遇到了主机问题，而误以为是集群配置问题。
:::

:::info 集群环境
三台服务器组成集成环境，服务器都是在线的服务器，如下：
- tx-1：【159.75.225.162】 **node1**，`master`，个人腾讯云
    - `CentOS Stream 9`：4核8G
- ali-2：【120.79.149.95】 **node2**，公司阿里云
    - `CentOS Stream 9`：2核4G
- aws-3：【52.194.241.105】 **node3**，日本节点亚马逊云
    - `Red Hat 9 Enterprise`：1核1G
:::

#### 整体步骤
- 安装：3个服务器都要进行
    - 下载Elasticsearch 8.7.0
    - 上传到服务器：/opt/soft-bar/
    - 解压到：/opt/es/（此时ES软件目录为：`/opt/es/es-8.7.0/`）
    - 补齐目录：`es-8.7.0/data`和`es-8.7.0/certs`
    - 创建es用户：创建一个专门的用户es，用来启动es服务
- 启动主节点
    - 先启动一个节点：主节点tx-1
        - 形成集群：主节点启动后，自动创建一个集群，其他节点只需要加入该集群
        - 创建证书：主节点启动后，会创建三张证书，用于TLS和节点间的通信
        - 启动安全配置，返回安全配置信息
    - 修改配置：修改主节点的配置，使其允许其他集群加入主节点创建的集群
    - 重启主节点：修改完配置后，删除data信息，重启节点
- 创建集群
    - 生成token：在主节点上生成token
    - 启动新节点：启动时，使新节点使用新生成的token。
    - 加入集群：新节点使用token时会自动生成和主节点相同的证书，从而加入集群。
    - 多个新节点：只需要重复进行前面三个步骤即可。

## 安装ES
ES8需要Java17，不过ES8会默认会捆绑JDK，所以不配置Java环境也可以。

三台服务区都要同步进行以下步骤进行初始的安装

#### 1. 下载ES
- 下载地址：[LINUX_X86_64](https://www.elastic.co/cn/downloads/past-releases#elasticsearch)

可以在本地下载上传到服务器，也可以直接在服务器进行wget下载。
```shell
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.7.0-linux-x86_64.tar.gz
```

#### 2. 上传安装包，规划目录
- 上传目录：`/opt/soft-bar/`，该目录用来存放安装包
- 工作目录：`/opt/es/`：该目录存放所有ES相关的内容
    - 解压目录：`/opt/es/es-8.7.0/`
    - 其他ES文件也都放在该目录下，包括Kibana

##### 3. 解压缩
```shell
cd /opt/soft-bar
tar -zxvf elasticsearch-8.7.0-linux-x86_64.tar.gz -C /opt/es
```

解压后的目录结构：

![4-3-1](/img/sql/es/4-3-1.jpg)

- bin：可执行脚本目录
- config：配置目录
- jdk：内置JDK
- lib：内置类库
- logs：日志目录
- modules：模块目录
- plugins：插件目录

##### 4. 补齐目录
解压后的目录结构还缺一个数据文件目录 `/data/` 和证书目录 `/config/certs`。

这俩目录会在首次启动ES时，自动创建。

#### 5. 创建es用户
Elasticsearch 不能使用 root用户启动，因此要创建一个名为es的用户操作Elasticsearch。
```shell
useradd es # 创建用户
passwd es # 设置密码，回车输入密码，这里暂密码暂定为es
chown -R es:es /opt/es/elasticsearch-8.7.0 # 修改文件拥有者
```




## 启动主节点
三台主机都配置好后，首先启动主节点tx-1，其他的主机不要启动。
```shell
# 启动服务
cd /opt/es/elasticsearch-8.7.0/
bin/e
```
:::tip
不做任何集群相关的配置，只启动一个节点，其实也是开启了集群，只是该集群只有一个节点，且默认不允许其他节点加入
:::

#### 1. 直接启动主节点
不用修改任何配置，采用默认的即可，直接启动主节点(tx-1)。

启动主节点后，会自动开启安全配置功能，包括：
- 创建证书：为传输层和HTTP层启用TLS，并自动生成用于配置TLS的密钥和证书
- 自动修改配置文件：自动在配置文件中加入安全配置信息
- 返回授权信息：启用身份认证和授权，并将授权信息返回
    - 内置超级用户​​elastic​​,并生成默认密码
    - 生成注册token等



#### 2. 创建证书
第一次启动节点时，会自动创建证书。证书是用来进行身份验证，防止请求被篡改的。仅在主节点（tx-1）上使用自动创建的证书，其他节点先别通过启动创建证书。

:::danger
不要再手动创建证书了，从ES8.4（也许更早）版本开始，证书是自动创建的，手动创建的证书可能会发生冲突。如下图，启动ES时，自动创建certs目录，并创建了3个证书
:::

创建的证书如下：

![4-3-6](/img/sql/es/4-3-6.jpg)

- http.p12：ssl证书，用与http的SSL通信
- http_ca.crt：ca证书
- transports.p12：节点证书，用于集群节点见通信

#### 3. 自动修改配置文件
第一次启动ES后，会自动开启安全配置功能，并修改配置文件，添加安全类配置：

```yaml
# Enable security features
## 1. 激活安全验证能模块
xpack.security.enabled: true
xpack.security.enrollment.enabled: true

# Enable encryption for HTTP API client connections, such as Kibana
## 2. 开启SSL验证，所有HTTP API都要进行SSL验证
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12 # 索引的证书

# Enable encryption and mutual authentication between cluster nodes
## 3.开启集群节点间的加密和相互认证功能
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12 # 节点通信的证书
  truststore.path: certs/transport.p12

# Create a new cluster with the current node only
# Additional nodes can still join the cluster later
## 4. 使用当前节点创建一个新集群，主节点就是当前主机名
## 其他节点随后可以加入该节点
cluster.initial_master_nodes: ["tx-1"]

# Allow HTTP API connections from anywhere
# Connections are encrypted and require user authentication
## 5. 允许所有IP访问 HTTP API 
http.host: 0.0.0.0

# Allow other nodes to join the cluster from anywhere
# Connections are encrypted and mutually authenticated
# 6. 节点通信配置：该配置允许其他任何ip的节点加入该集群，默认是没有开启的。
#transport.host: 0.0.0.0
```

#### 4. 返回授权信息
开启安全配置功能，还会启用身份认证和授权，并将授权信息返回。

返回的内容如下：

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ Elasticsearch security features have been automatically configured!

✅ Authentication is enabled and cluster connections are encrypted.

ℹ️  Password for the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`):

*IXlAmG6eb1V57\*bN72gx* 

ℹ️  HTTP CA certificate SHA-256 fingerprint:

*050f72bcd20a7a53ac68cb37663c37d318f1e71af2c8c98b16e58dcdfa83909c*

ℹ️  Configure Kibana to use this cluster:
- Run Kibana and click the configuration link in the terminal when Kibana starts.
- Copy the following enrollment token and paste it into Kibana in your browser (valid for the next 30 minutes):

*eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTYuMC45OjkyMDAiXSwiZmdyIjoiMDUwZjcyYmNkMjBhN2E1M2FjNjhjYjM3NjYzYzM3ZDMxOGYxZTcxYWYyYzhjOThiMTZlNThkY2RmYTgzOTA5YyIsImtleSI6IlNDTmNHb2tCTWlMRHlaaVVYUTNGOnZibmJUdUFLUjhTRjZ1aXVHU0xZTlEifQ==*

ℹ️  Configure other nodes to join this cluster:
- On this node:
    - Create an enrollment token with `bin/elasticsearch-create-enrollment-token -s node`.
    - Uncomment the transport.host setting at the end of config/elasticsearch.yml.
    - Restart Elasticsearch.
- On other nodes:
    - Start Elasticsearch with `bin/elasticsearch --enrollment-token <token>`, using the enrollment token that you generated.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

##### 信息总结：
- 用户名：elastic（这个用户是超级用户，系统内置的用户名）
- 密码：xbqtuCmjMmlU6b_OXhsg
- Kibana token：用于配置Kibana，有效时间30分钟
- 其他节点加入该集群的步骤
    - 在该节点上：
        - 创建一个注册token
        - 修稿配置文件中的：transport.host，允许其他节点加入
        - 重启当前ES节点
    - 在新的节点上
        - 修改配置文件
        - 在启动节点时，使用主节点产生的注册token
#### 5. 验证主节点
登录主节点，查看主节点状态。

输入`https://ip或hostname:端口号/` 进行访问

当前配置的URL： https://159.75.225.162:9200/ （没有主机映射，就直接用ip访问了）

第一次访问要输入账号和密码，就是第一次启动ES时返回的账号密码（换一个客户端就要输一次密码）。

![4-3-4](/img/sql/es/4-3-4.jpg)

登录后的页面：

![4-3-5](/img/sql/es/4-3-5.jpg)

则表示服务正常启动，且能访问了。


## 创建集群
#### 1. 主节点：修改配置文件
在主节点上修改集群配置信息、开发其他节点的访问。
```yaml
cluster.name: es-com
node.name: node-1
path.data: /opt/es/elasticsearch-8.7.0/data
path.logs: /opt/es/elasticsearch-8.7.0/logs
network.host: 0.0.0.0
http.port: 9200
transport.host: 0.0.0.0
discovery.seed_hosts: ["159.75.225.162","120.79.149.95","52.194.241.105"]
cluster.initial_master_nodes: ["node-1"]
```

#### 1. 主节点：生成注册token
:::warning
- 生成token时，要保证主节点正常运行。
- 生成token要发生在修改配置文件之后，主节点配置文件修改了，就要重新生成token
:::
在主节点上生成注册token，用于其他节点启动时加入该节点
```shell
cd /opt/es/elasticsearch-8.7.0/bin
./elasticsearch-create-enrollment-token -s node
```
返回了一个token字符串：

*eyJ2ZXIiOiI4LjcuMCIsImFkciI6WyIxNzIuMTYuMC45OjkyMDAiXSwiZmdyIjoiMDUwZjcyYmNkMjBhN2E1M2FjNjhjYjM3NjYzYzM3ZDMxOGYxZTcxYWYyYzhjOThiMTZlNThkY2RmYTgzOTA5YyIsImtleSI6IncwUE1Hb2tCOFBVZWxlWWs0VFlZOmY2aFF6dHVQUTV1OU4xVURPZHh5TXcifQ==*

#### 2. 新节点：启动节点，附加注册token


##### debug
- token 失效：
    - 报错：Aborting enrolling to cluster. Could not communicate with the node on any of the addresses from the enrollment token. All of [172.16.0.9:9200] were attempted.
    - 解决：使用主节点重新生成一个token







## 配置文件
修改主配置文件：config/elasticsearch.yml，三台机器要分别修改。

注意修改的配置项说明：
- 名称
    - cluster.name：集群名称，节点之间要保持一致
    - node.name：节点名称，集群内要唯一
        - 如果不配置，就默认是当前主机的hostname
- IP
    - network.host：允许访问es服务的IP地址。
        - 默认：localhost，即：仅运行当前ip访问
        - `0.0.0.0`：表示所有服务器都可以访问，需要配置安全信息
    - http.port：ES服务的端口，默认是9200
- 目录
    - path.data：索引数据的目录
    - path.logs：日志所在目录
- 集群
    - transport.port：TCP 监听端口，用于节点内部通信
        - 不用配置，默认就是9300
    - discovery.seed_hosts：被查询发现的其他节点的
        - 只需要配置其他节点的ip即可，默认会使用transport.port进行通信
    - cluster.initial_master_nodes：初始主节点
        - 开启一个全新的集群时，会有一个集群的引导步骤，这步骤用来确定哪些节点参与第一次的主节点选举
        - 做法：在第一个启动的节点处配置，配置是当前节点的hostname（或node.name）
        - 该配置仅在第一次启动集群有效，其他节点加入集群，或重启集群都是无效的，可以注释掉。

#### 1. tx-1：node-1
```yml
# ES文件和日志的目录
path.data: /opt/es/elasticsearch-8.7.0/data
path.logs: /opt/es/elasticsearch-8.7.0/logs

# 生产时：不设置或localhost = 仅允许本机访问，更安全，
# 开发时：0.0.0.0 = 允许网络上所有的主机访问ES服务
network.host: 0.0.0.0 # 开发时设置成

# 端口，默认就是9200，不设置也可以
http.port: 9200
```



#### 1. 启动ES
```shell
# 启动服务
cd /opt/es/elasticsearch-8.7.0/
bin/elasticsearch
```


#### 2. 守护进程
ES默认启动的方式是前台启动，第一次前台启动为了获取密码信息，之后可以选择守护进程的方式启动
```shell
su es
cd /opt/es/elasticsearch-8.7.0/

# 后台启动服务
bin/elasticsearch -d

# 重启服务：重复启动命令就会重启

# 停止ES运行：查询ES的pid，然后手动kill
ps -ef | grep elastic 
kill -9 pid
```






## debug
一些启动时可能会出现的问题。
#### 1. 默认JVM内存过大
ES内置JVM的默认内存是4G。

如果Linux服务器剩余内存过小，就会直接卡死，可以按照优化章节的内容重新配置内存

ES 目录的 config/jvm.options文件是用来配置内存的。
```yaml
################################################################
## IMPORTANT: JVM heap size
################################################################
## -Xms4g
## -Xmx4g
-Xms1g  # 初始启动大小
-Xmx1g  # 可分配的最大内置值
```

#### 2. 虚拟内存过小 
报错：`max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]`，虚拟内存过小，只有65530，至少需要262144

将虚拟内存修改层262144
```shell
# 查看当前虚拟内存
cat /proc/sys/vm/max_map_count # 65530 

# 修改虚拟内存
sudo sysctl -w vm.max_map_count=262144 # vm.max_map_count=262144

# 再次查看当前内存
cat /proc/sys/vm/max_map_count # 262144
```

PS :主机若进行了重启，就要重新修改虚拟内存

#### 3. 协议错误
- 报错：received plaintext http traffic on an https chann
配置了ssl，就要用https访问，而不是http


#### 4. 忘记密码
第一次启动ES会返回密码信息，如果没有保存，可以采用指令重置密码

PS: 用户名默认是elastic
```shell
cd /opt/es/elasticsearch-8.7.0/
bin/elasticsearch-reset-password -u elastic
```
#### 5. 权限不够
Exception in thread "main" java.nio.file.AccessDeniedException: /opt/es/elasticsearch-8.7.0/config/elasticsearch.keystore


#### 证书错误
http client did not trust this server's certificate


#### 该节点是单节点
setting. Fully-formed clusters do not attempt to discover other nodes, and nodes with different cluster UUIDs cannot belong to the same cluster. The cluster UUID persists across restarts and can only be changed by deleting the contents of the node's data path(s). Remove the discovery configuration to suppress this message

Aborting enrolling to cluster. Could not communicate with the node on any of the addresses from the enrollment token. All of [172.16.0.9:9200] were attempted

#### 默认线程数太少，要修改成4080
max number of threads [3565] for user [ec2-user] is too low, increase to at least [4096]

#### 端口限制
有些云平台的主机看似关闭了防火墙，但平台网关其实开启了防火墙，且是以白名单的形式，比如阿里云。此时9200端口是禁止访问的，在主机上查看防火墙是关闭状态，这只能在云平台的安全组中进行设置。