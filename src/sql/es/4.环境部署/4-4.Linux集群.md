---
title: 4-4. Linux集群
date: 2023-06-28
---
:::tip
Linux上的Elasticsearch集群和单机的部署方式差不多，就多了一些集群方面的配置。

这里和单机版的配置有大量重复内容。
:::
## 整体步骤


## 安装
ES8需要Java17，不过ES8会默认会捆绑JDK，所以不配置Java环境也可以。
#### 1. 下载ES
- 下载地址：[LINUX_X86_64](https://www.elastic.co/cn/downloads/past-releases#elasticsearch)

可以在本地下载上传到服务器，也可以直接在服务器进行wget下载。
```js
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.7.0-linux-x86_64.tar.gz
```

#### 2. 上传安装包，规划目录
- 上传目录：`/opt/soft-bar/`，该目录用来存放安装包
- 工作目录：`/opt/es/`：该目录存放所有ES相关的内容
    - 解压目录：`/opt/es/es-8.7.0/`
    - 其他ES文件也都放在该目录下，包括Kibana

##### 3. 解压缩
```shell
cd /opt/soft-bar
tar -zxvf elasticsearch-8.7.0-linux-x86_64.tar.gz -C /opt/es
```

解压后的目录结构：

![4-3-1](/img/sql/es/4-3-1.jpg)

- bin：可执行脚本目录
- config：配置目录
- jdk：内置JDK
- lib：内置类库
- logs：日志目录
- modules：模块目录
- plugins：插件目录

##### 4. 补齐目录
解压后的目录结构还缺一个数据文件目录和证书目录。
```shell
cd /opt/es/elasticsearch-8.7.0
mkdir data # 创建数据文件目录
mkdir certs # 创建证书目录
```

#### 5. 创建es用户
Elasticsearch 不能使用 root用户启动，因此要创建一个名为es的用户操作Elasticsearch。
```shell
useradd es # 创建用户
passwd es # 设置密码，回车输入密码，这里暂密码暂定为es
chown -R es:es /opt/es/elasticsearch-8.7.0 # 修改文件拥有者
```

## CA证书
证书是用来进行身份验证，防止请求被篡改的。不使用证书可能会报错。

ES通过内置的elasticsearch-certutil工具来生成证书。
```shell
cd /opt/es/elasticsearch-8.7.0/config
mkdir certs
cd ..
mv elastic-* config/certs
```

#### 1. CA模式。
创建证书有四种模式：ca、cert、csr、http，我们这里采用CA模式
- CA模式生成新的证书颁发机构(ca)。默认情况下，它生成一个PKCS#12输出文件，其中保存CA证书和CA的私钥。
- 也可以指定–pem参数，则命令生成一个zip文件，其中包含PEM格式的证书和私钥。随后可以使用这些文件作为命令的cert模式的输入。
- PKCS#12文件：一种交换数字证书的加密标准。通常用它来加密打包一个私钥及有关的 X.509 证书，产生的文件就是PKCS#12文件。


#### 2. CA证书
- 证书：用来证明受访问的服务身份信息。
- 签名：存在证书上的一个可信标识，代表该证书是经过认证的，因为假冒服务器也可以有证书。
- CA证书：是公认可靠的CA(certificate authority)机构签发的证书

![4-3-2](/img/sql/es/4-3-2.jpg)

#### 3. CA证书工作机理
通过HTTPS请求的步骤来说明CA证书的工作机理
- 浏览器发起https请求
- 服务器返回它的证书
- 浏览器通过CA的公钥对证书签名进行校验，检查证书是否有效
- 浏览器生成一个临时秘钥并用服务器的公钥对它加密，然后将其发送给服务器。
- 服务器用私钥解密，得到浏览器发送给它的秘钥， 然后用该秘钥对数据进行加密
- 浏览器得到加密数据，并用发给服务端的秘钥进行解密。

![4-3-3](/img/sql/es/4-3-3.jpg)


#### 4. 签发ca证书
需要用到内置的`elasticsearch-certutil ca` 命令，在 elasticsearch-8.7.0/bin目录中

```shell
su es # 切换用户
cd  /opt/es/elasticsearch-8.7.0/bin # 进入bin目录
./elasticsearch-certutil ca # 签发 ca 证书

# 签发 ca 证书时有两次交互，直接回车即可
# 第一次交互：设置文件名，回车采用默认名，默认文件在ES软件根目录中
Please enter the desired output file [elastic-stack-ca.p12]: 
# 第二次交互：设置ca证书密码，直接回车将采用空密码，如果设置了要保存后，后续会用
Enter password for elastic-stack-ca.p12 :  # 设置密码
```
默认生成的证书位置：/opt/es/elasticsearch-8.7.0/elastic-stack-ca.p12


@@@@@@@@@@@@@@集群配置专属@@@@@@@@@@@@@@
#### 5. 生成秘钥（节点证书）
使用ca证书生成秘钥，作发节点的证书，该证书用于节点之间的通信（集群多节点通信秘钥）

```shell
# 用户 和目录同上：elastic-stack-ca.p12就是刚刚生成的ca节点证书
./elasticsearch-certuil cert --ca elastic-stack-ca.p12

# 签发过程有三次交互
# 第一次交互：设输入ca证书的密码，之前没有设置密码就直接回车
Enter password for CA (elastic-stack-ca.p12) : 
# 第二次交互：设置节点证书的文件名，直接回车采用默认的
Please enter the desired output file [elastic-certificates.p12]: 
# 第三次交互：
Enter password for elastic-certificates.p12 :
```
签发完成后，就在ES 根目录中生成了elastic-certificates.p12，它是单个PKCS#12密钥存储库，其中包括节点证书、节点密钥和CA证书。

集群中每个节点都可以使用该证书

@@@@@@@@@@@@@@集群配置专属@@@@@@@@@@@@@@

#### 5. 移动证书
生成的证书要放到到config目录内，可以在config目录下创建certs目录用来存放证书。


#### 6. 签发HTTP证书
:::danger 注意
注意：使用使用 elasticsearch-certutil 工具自己生成的CA，签发的证书属于自认证证书，该证书浏览器是不不会信任的，需要手动让浏览器信任。

可以选择使用第三方签发的受信任的证书。
:::
使用CA证书签发HTTP证书，以便可以使用HTTP REST API方式访问ES服务。

其他组件（例如 Kibana 或任何 Elastic 语言客户端）在连接到 ES服务 时会验证此证书。

生成证书的流程很复杂，交互很多，如下：
```shell
# 用户 和目录同上
./elasticsearch-certutil http


# 生成http证书的过程要进行多次交互
# 第1次: 是否生成证书签名请求
Generate a CSR? [y/N] # n

# 第2次: 是否要使用现有 CA
Use an existing CA? [y/N] # y

# 第3次: 指定ca证书的路径：以es软件/config为起始路径
CA Path: # certs/elastic-stack-ca.p12 

# 第4次: 输入CA证书的密码，之前没有创建，这里直接回车
Password for elastic-stack-ca.p12: # 直接回车

# 第5次: 证书的生效时间：默认是5y(5年)
For how long should your certificate be valid? [5y] # 20y # 设置成了20年

# 第6次: 是否为每个节点创建一个单独的证书：不需要，即使是集群也只需主节点创建证书
Generate a certificate per node? [y/N] # n

# 第7和8是用来配置DNS与证书绑定的：域名->ip：绑定证书
# 第7次：输入链接到ES的主机名称 # 如果是集群需要所如所有集群的主机名称
## 列出将用于连接的每个主机名（域名），如果该域名没有被解析，就需要本地进行hosts映射
## 实在没有进行过解析，这里直接输入域名也可以
aicell.cc # 回车一次就可以输入一个名字，两次回车就输入完毕
Is this correct [Y/n] #y，确认名字输入是否正确

# 第8次: 输入主机名对应的ip地址，ip解析后就是之前输入的域名
## 如果是单节点集群，就要指定端口号
159.75.225.162 # 要与主机名对应，
Is this correct [Y/n] #y，确认名字输入是否正确
## Key Name: aicell.cc 
## Subject DN: CN=aicell，DC=cc


# 第9次: 是否对集群中的每个节点重复上述操作，不用
Do you wish to change any of these options? [y/N] # n 

# 第10次: 是否给证书加密
Provide a password for the "http.p12" file:  # 连续回车两次，不加密
```

完成上述10个步骤，证书就生成好了，是一个压缩包，需要解压获取证书。

证书位置：/opt/es/elasticsearch-8.7.0/elasticsearch-ssl-http.zip


#### 7. 解压并移动http证书
##### 7.1 解压http证书
```shell
cd  /opt/es/elasticsearch-8.7.0 
unzip elasticsearch-ssl-http.zip
```
解压后会在`/opt/es/elasticsearch-8.7.0/` 目录下产生两个信息目录
- elasticsearch：目录内有http.p12证书
- kibana：目录内有elasticsearch-ca.pem证书


#### 7.2 移动证书
将两个证书移动到certs目录中。
```shell
cd  /opt/es/elasticsearch-8.7.0 
mv elasticsearch/http.p12 kibana/elasticsearch-ca.pem config/certs
rm -rf elasticsearch kibana # 删除之前生成的目录
mv elasticsearch-ssl-http.zip ../ # 将http证书压缩包移动到别的位置，备份
```


## 配置文件
修改主配置文件：config/elasticsearch.yml
```yml

```


## 启动ES


## debug
#### 1. 默认JVM内存过大


#### 2. 虚拟内存过小 
报错：`max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]`，虚拟内存过小，只有65530，至少需要262144

将虚拟内存修改层262144
```shell
# 查看当前虚拟内存
cat /proc/sys/vm/max_map_count # 65530 

# 修改虚拟内存
sudo sysctl -w vm.max_map_count=262144 # vm.max_map_count=262144

# 再次查看当前内存
cat /proc/sys/vm/max_map_count # 262144
```

#### 3. 协议错误
- 报错：received plaintext http traffic on an https chann
配置了ssl，就要用https访问，而不是http