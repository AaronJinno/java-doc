---
title: 5-2. 分布式集群
date: 2023-06-28
---

## 系统架构
![5-2-1](/img/sql/es/5-2-1.jpg)

如图：（节点数：3、分片数：2、备份数：1）
- 节点：集群有三个节点，其中Node1是主节点  
    - 主节点在启动时根据配置指定，在运行中可以选举产生
- 分片：索引被分片储存了，储存在了各个节点：P0、P1、P2
    - 并非每个节点都有一个分片，而是根据规则创建，所以上图只有两个分片
- 副本：每个分片都有自己的副本，P0->R0、P1->R1、P2->R2
    - 副本跟被复制的分片肯定是不能在同一个节点的（高可用）
    - 副本数量也不是和节点关联的，而且根据设置的规则创建，默认是1个副本


#### 1. 概述
一个运行中的 Elasticsearch 实例称为一个节点，而集群是由一个或者多个拥有相同
`cluster.name`（集群名） 配置的节点组成， 它们共同承担数据和负载的压力。

当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。

#### 2. 主节点
当一个节点被选举成为主节点时， 它将负责管理集群范围内的所有变更，例如增加、删除索引，或者增加、删除节点等。 

主节点并不需要涉及到文档级别的变更和搜索等操作，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。 任何节点都可以成为主节点。

#### 3. 请求处理
- 可以将请求发送到集群中的任何节点，包括主节点。
- 每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。 
- 无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回給客户端。 Elasticsearch 对这一切的管理都是透明的。

## 单节点集群
单节点集群指的是集群中只有一个节点，该节点内包含有多个分片和副本。实际开发中不会出现单节点集群，这里只是为了演示集群的原理。

#### 1. 创建单节点集群
创建单节点集群，并查看集群信息

GET请求`http://localhost:9300/_cluster/health`查看集群的节点信息，返回如下信息：
```json
{
    "cluster_name": "my-es",
    "status": "green", //状态为green
    "timed_out": false,
    "number_of_nodes": 1, //单节点
    "number_of_data_nodes": 1, 
    //分片信息都是0
    "active_primary_shards": 0,
    "active_shards": 0,
    "relocating_shards": 0,
    "initializing_shards": 0,
    "unassigned_shards": 0,
    "delayed_unassigned_shards": 0,
    "number_of_pending_tasks": 0,
    "number_of_in_flight_fetch": 0,
    "task_max_waiting_in_queue_millis": 0,
    "active_shards_percent_as_number": 100.0
}
```

#### 2. 索引分片
创建完单节点集群后，创建名为 users 的索引，并将索引分成3个主分片和一份副本（每个主分片拥有一个副本分片）

通过PUT请求 `http://localhost:9300/user`创建索引，并通过以下请求体进行分片
```json
{
    "settings":{
        "number_of_shards":3, //创建的分片数量
        "number_of_replicas":1 //创建的副本数量，每个分片都会有副本的
    }
}
```

创建成功后，再次发送请求，查询节点信息
```json
{
    "cluster_name": "my-es",
    "status": "yellow", //状态为yellow
    "timed_out": false, 
    "number_of_nodes": 1, //单节点
    "number_of_data_nodes": 1,
    "active_primary_shards": 3, //主分片：3个
    "active_shards": 3, 
    "relocating_shards": 0,
    "initializing_shards": 0,
    "unassigned_shards": 3,
    "delayed_unassigned_shards": 0,
    "number_of_pending_tasks": 0,
    "number_of_in_flight_fetch": 0,
    "task_max_waiting_in_queue_millis": 0,
    "active_shards_percent_as_number": 50.0
}
```
#### 3. 通过插件查看集群情况




## 单点故障


## 水平扩容

## 集群故障处理

## hello