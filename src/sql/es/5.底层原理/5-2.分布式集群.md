---
title: 5-2. 分布式集群
date: 2023-06-28
---

## 系统架构
![5-2-1](/img/sql/es/5-2-1.jpg)

如图：（节点数：3、分片数：2、备份数：1）
- 节点：集群有三个节点，其中Node1是主节点  
    - 主节点在启动时根据配置指定，在运行中可以选举产生
- 分片：索引被分片储存了，储存在了各个节点：P0、P1、P2
    - 并非每个节点都有一个分片，而是根据规则创建，所以上图只有两个分片
- 副本：每个分片都有自己的副本，P0->R0、P1->R1、P2->R2
    - 副本跟被复制的分片肯定是不能在同一个节点的（高可用）
    - 副本数量也不是和节点关联的，而且根据设置的规则创建，默认是1个副本


#### 1. 概述
一个运行中的 Elasticsearch 实例称为一个节点，而集群是由一个或者多个拥有相同
`cluster.name`（集群名） 配置的节点组成， 它们共同承担数据和负载的压力。

当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。

#### 2. 主节点
当一个节点被选举成为主节点时， 它将负责管理集群范围内的所有变更，例如增加、删除索引，或者增加、删除节点等。 

主节点并不需要涉及到文档级别的变更和搜索等操作，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。 任何节点都可以成为主节点。

#### 3. 请求处理
- 可以将请求发送到集群中的任何节点，包括主节点。
- 每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。 
- 无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回給客户端。 Elasticsearch 对这一切的管理都是透明的。

## 单节点集群
单节点集群指的是集群中只有一个节点，该节点内可以包含有多个分片和副本。实际开发中不会出现单节点集群，这里只是为了演示集群的原理。

#### 1. 创建单节点集群
创建单节点集群，并查看集群信息

GET请求`http://localhost:9300/_cluster/health`查看集群的节点信息，返回如下信息：
```json
{
    "cluster_name": "my-es",
    "status": "green", //状态为green
    "timed_out": false,
    "number_of_nodes": 1, //单节点
    "number_of_data_nodes": 1, 
    //分片信息都是0
    "active_primary_shards": 0,
    "active_shards": 0,
    "relocating_shards": 0,
    "initializing_shards": 0,
    "unassigned_shards": 0,
    "delayed_unassigned_shards": 0,
    "number_of_pending_tasks": 0,
    "number_of_in_flight_fetch": 0,
    "task_max_waiting_in_queue_millis": 0,
    "active_shards_percent_as_number": 100.0
}
```

#### 2. 索引分片
创建完单节点集群后，创建名为 users 的索引，并将索引分成3个主分片和一份副本（每个主分片拥有一个副本分片）

通过PUT请求 `http://localhost:9300/user`创建索引，并通过以下请求体进行分片
```json
{
    "settings":{
        "number_of_shards":3, //创建的分片数量
        "number_of_replicas":1 //创建的副本数量，每个分片都会有副本的
    }
}
```
##### 2.1 查询集群信息
创建成功后，再次发送请求，查询集群信息
```json
{
    "cluster_name": "my-es",
    "status": "yellow", //状态为yellow
    "timed_out": false, 
    "number_of_nodes": 1, //单节点
    "number_of_data_nodes": 1,
    "active_primary_shards": 3, //主分片：3个
    "active_shards": 3, 
    "relocating_shards": 0,
    "initializing_shards": 0,
    "unassigned_shards": 3,
    "delayed_unassigned_shards": 0,
    "number_of_pending_tasks": 0,
    "number_of_in_flight_fetch": 0,
    "task_max_waiting_in_queue_millis": 0,
    "active_shards_percent_as_number": 50.0
}
```
##### 2.2 查询索引信息
发送请求查看刚创建的索引信息。
```json
{
    "user": {
        "aliases": {},
        "mappings": {},
        "settings": {
            "index": {
                "routing": {
                    "allocation": {
                        "include": {
                            "_tier_preference": "data_content"
                        }
                    }
                },
                "number_of_shards": "3", //分片数量3
                "provided_name": "user",
                "creation_date": "1688003784177",
                "number_of_replicas": "1", //副本数量1
                "uuid": "FhGd7_y9RHmSAgkRqZj7kA",
                "version": {
                    "created": "8080199"
                }
            }
        }
    }
}
```

#### 3. 分析集群情况
集群现在是拥有一个索引的单节点集群。所有 3 个主分片都被分配在 node-1
##### 3.1 elasticsearch-head插件
可以安装浏览器插件elasticsearch-head，然后进去插件，输入地址，查看集群情况

![5-2-2](/img/sql/es/5-2-2.jpg)

加星号的是主节点，另一个是副节点。

##### 3.2 分析
如上图，分析集群的情况：
- ==集群健康值:yellow( 3 of 6 )==：表示当前集群的全部主分片都正常运行，但是副本分片没有全部处在正常状态
- node-9300：3个主分片都正常（绿色的）
- Unassigned：3 个副本分片都是 Unassigned，它们都没有被分配到任何节点。 在同
一个节点上既保存原始数据又保存副本是没有意义的，因为一旦失去了那个节点，我们也将丢失该节点上的所有副本数据。

总结：当前我们的集群是正常运行的，但是在硬件故障时有丢失数据的风险

## 单点故障
当集群中只有一个节点在运行时，意味着会有一个单点故障问题——没有冗余（高可用）。 

#### 1. 启动第二个节点
为集群启动第二个节点（它和第一个节点有同样的 cluster.name 配置），它会自动发现集群并加入到其中。

#### 2. 查看集群情况
再次使用elasticsearch-head插件，查看集群情况。

![5-2-3](/img/sql/es/5-2-3.jpg)

- 集群健康值：green( 6 of 6 ) : 表示所有 6 个分片（包括 3 个主分片和 3 个副本分片）都在正常运行。
- node-9300：3 个主分片正常
- node-9400：3个副本分片也正常，且和主分片不再同一个节点

#### 3. 总结
当第二个节点加入到集群后，3 个副本分片将会分配到这个节点上——每个主分片对应一个副本分片。这意味着当集群内任何一个节点出现问题时，我们的数据都完好无损。

所有新近被索引的文档都将会保存在主分片上，然后被并行的复制到对应的副本分片上。这就保证了我们既可以从主分片又可以从副本分片上获得文档。


## 水平扩容
水平扩容指的是：增加节点数量，从而加大数据的吞吐量和性能。

#### 1. 启动第三个节点
当启动了第三个节点，集群将会拥有三个节点，集群为了分散负载会对分片进行重新分配。

#### 2. 查看集群情况
使用elasticsearch-head插件，查看三个节点的集群情况。

![5-2-4](/img/sql/es/5-2-4.jpg)

- 集群健康值:green( 6 of 6 ) : 表示所有 6 个分片（包括 3 个主分片和 3 个副本分片）都在正常运行，（增加节点不会凭空增加副本数量）。
- 分片：node-9300和node-9400上各有一个分片被迁移到了新的 Node-9500节点

现在每个节点上都拥有 2 个分片，而不是之前的 3 个。 这表示每个节点的硬件资源（CPU, RAM, I/O）将被更少的分片所共享，每个分片的性能将会得到提升。

#### 3. 扩容的节点数量
分片是一个功能完整的搜索引擎，它拥有使用一个节点上的所有资源的能力。 我们这个拥有 6 个分片（3 个主分片和 3 个副本分片）的索引可以最大扩容到 6 个节点，每个节点上存在一个分片，并且每个分片拥有所在节点的全部资源。

原因：主分片三个，副分片三个，最多一个节点一个分片，也就是最多扩容到6个节点。

#### 4. 多个副本
如果扩容的节点数量超过了分片数量（超过6个节点），将会有空闲的节点。

主分片的数目在索引创建时就已经确定了下来。实际上，这个数目定义了这个索引能够
存储 的最大数据量。（实际大小取决于你的数据、硬件和使用场景。） 

但是，读操作——搜索和返回数据——可以同时被主分片 或 副本分片所处理，所以当你拥有越多的副本分片时，也将拥有越高的吞吐量（同时高可用也增加了）。

在运行中的集群上是可以动态调整副本分片数目的，可以按需伸缩集群，比如将副本数量变成2：
- 请求方式：PUT
- 请求URL：http://localhost:9300/user/_settings
- 请求体如下
```json
{
    "settings":{
        "number_of_replicas":2
    }
}
```

#### 5. 再次查看集群情况
设置成两个副本后，再次通过 elasticsearch-head 插件查看集群情况

![5-2-5](/img/sql/es/5-2-5.jpg)

如图：users 索引现在拥有 9 个分片：3 个主分片和 6 个副本分片。 每个分片有两个副本，此时可以将以将集群扩容到 9 个节点，每个节点上一个分片。相比原来 3 个节点时，集群搜索性能可以提升 3 倍。

不扩容节点，创建多个副本不会增加性能，只是增加了高可用。


## 集群故障处理
#### 1. 节点丢失
关闭一个节点后，再次查看集群状态，如图：（关闭node-9300，主节点）

![5-2-6](/img/sql/es/5-2-6.jpg)

如图，主节点丢失了，集群必须拥有一个主节点来保证正常工作，所以发生的第一件事情就是选举一个新的主节点：Node-9400 。

关闭 Node-9300的同时也失去了主分片，在缺失主分片的时候理论上索引也不能正常工作（集群状态red），不过node-9400和node-9500节点上存在着主分片的完整副本，所以新的主节点立即将备份的副分片提升为主分片, 此时集群的状态将会为yellow。这个提升主分片的过程是瞬间发生的。


#### 2. 节点恢复
恢复丢失的节点（重启node-9300），再次查看集群状态，如图：

![5-2-7](/img/sql/es/5-2-7.jpg)

节点恢复后，集群可以将缺失的副本分片再次进行分配，那么集群的状态也将恢复成之前的状态。如果丢失的节点依然拥有着之前的分片，它将尝试去重用它们，同时仅从主分片复制发生了修改的数据文件。和之前的集群相比，只是 Master 节点切换了。
