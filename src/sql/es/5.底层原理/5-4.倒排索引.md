---
title: 5-4. 倒排索引
date: 2023-06-29
---

## 正排索引
:::tip
ElasticSearch采用的是倒排索引，在此之前先了解下正排索引。
:::
#### 1.概述
又称正向索引，当用户发起查询时（假设查询为一个关键词），搜索引擎会扫描索引库中的所有文档，找出所有包含关键词的文档，这样依次从文档中去查找是否含有关键词的方法叫做正向索引。

#### 2. 正向索引的结构
![1-3-2](/img/sql/es/1-3-2.jpg)

#### 3. 正向索引解析
我们查询数据时，输入的是`关键字`,搜索引擎会扫描库中包含该关键字的所有文档，然后返回文档的id，通过id获取文档，我们就可以查询到结果了。


#### 4. 正向索引的缺点
对于文档的查询来说，一个站点存在的文档可能会非常多，这样遍历的索引结构效率低下，无法满足用户需求。

因此才有了对文档搜索效率更高的倒排索引。

## 关键字-文档矩阵
:::tip
先了解下关键字与文档之间的关系。
:::
单词-文档矩阵是表达两者之间所具有的一种包含关系的概念模型。

#### 示例
如下几个文档：
- d1：马斯克创建了SpaceX
- d2：SpaceX 星舰下个月发射
- d3：马斯克说将亲自指挥星舰的发射

此时，用户将以马斯克、SpaceX和星舰进行查询，关键字与文档的矩阵为：

| |d1|d2|d3|
|:--:|:--:|:--:|:--:|
|马斯克|√||√|
|SpaceX|√|√||
|星舰||√|√|

#### 矩阵解读
- 横向：表示哪些文档包含了该关键字，d1和d3包含了 `马斯克` 这个关键字
- 纵向：表示每个单独的文档包含了哪些关键字，如果d1包含了马斯克和SpaceX

#### 搜索引擎的索引
搜索引擎的索引其实就是实现 `关键字-矩阵`的具体数据结构。可以有不同的方式来实现上述概念模型
- 正排索引：创建的索引是文档的id，搜索的过程是遍历每一个文档，比对是否有所要查询的关键字，如果有就记录文档的id，最后返回所有的文档id。
    - 然后通过文档id获取对应的文档作为结果呈现。
    - 这种方式非常的低效
- 倒排索引：为所有关键字创建索引，关键字对应的值就是包含该关键字的所有文档id。搜索的过程是直接通过索引拿到关键字对应的文档id。
    - 然后通过id获取对应的文档作为结果呈现。
    - 这种方式是最佳的方案，ES就采用了这种方案。
- 其他方式：签名文件、后缀树等，这些方式的效率也都不如倒排索引。


## 倒排索引
#### 1. 概述
倒排索引(Inverted Index)：倒排索引是实现“单词-文档矩阵”的一种具体存储形式，通过倒排索引，可以根据单词快速获取包含这个单词的文档列表。

单词，又称词条，也可以称之为关键字，他是创建文档的“字段“

#### 2. 倒排索引的结构
为了增加效率，搜索引擎会把正向索引变为反向索引（倒排索引）即把“文档→单词”的形式变为“单词→文档”的形式。倒排索引具体机构如下:
- 单词1→文档1的ID；文档2的ID；文档3的ID…
- 单词2→文档1的ID；文档4的ID；文档7的ID…

#### 3. 组成
倒排索引主要由两个部分组成：“单词词典”和“倒排文件”。
- 单词词典(Lexicon)：搜索引擎的索引单位是单词，单词词典是由文档集合中出现过的所有单词构成的字符串集合，单词词典内每条索引项记载单词本身的一些信息以及指向“倒排列表”的指针。
- 倒排列表(PostingList)：倒排列表记载了出现过某个单词的所有文档的文档列表及单词在该文档中出现的位置信息，每条记录称为一个倒排项(Posting)。根据倒排列表，即可获知哪些文档包含某个单词。
- 倒排文件(Inverted File)：所有单词的倒排列表往往顺序地存储在磁盘的某个文件里，这个文件即被称之为倒排文件，倒排文件是存储倒排索引的物理文件。

![1-3-3](/img/sql/es/1-3-3.jpg)

#### 4. 倒排索引的简单实现示例
如下几个文档：
- d1：马斯克创建了SpaceX
- d2：SpaceX 星舰下个月发射
- d3：马斯克说将亲自指挥星舰的发射

通过这5个文档建立简单的倒排索引:

|单词id|关键字（单词）|倒排列表|
|:--:|:--:|:--:|
|1|马斯克|`{1,3}`|
|2|SpaceX|`{1,2}`|
|3|星舰|`{2,3}`|

首先要用分词系统将文档自动切分成单词序列，这样就让文档转换为由单词序列构成的数据流，并对每个不同的单词赋予唯一的单词编号(WordID)，并且每个单词都有对应的含有该单词的文档列表即倒排列表。

##### 略微复杂的倒排列表
下面介绍一种更加复杂，包含信息更多的倒排索引。

|单词id|关键字（单词）|倒排列表`(文档id;TF;<Pos>)`|
|:--:|:--:|:--:|
|1|马斯克|(1;1;<1>),(3;1;<1>)|
|2|SpaceX|(1;1;<7>),(2;1;<1>)|
|3|星舰|(2;1;<7>),(3;1;<10>)|

- TF：单词在文档中出现的次数
- Pos: 单词在文档中出现的位置，也就是字符顺序

这个表格展示了更加复杂的倒排索引，前两列不变，第三列倒排索引包含的信息为(文档ID，单词频次，<单词位置>)

## 匹配处理
#### 1. 词条的分词
ES搜索的基本单位是单词（词条，创建索引时的字段），也可以称之为关键字。对于英文来说就是一个单词或词组，对于汉语来说就是汉字和词语。


词条也可以可以进行分词的，与词条的种类有关，创建文档时，词条（字段）的类型如果是keyword就不能分词，如果是text就可以分词。

示例：比如词条苹果手机，可以分词为：苹果和手机（具体怎么分词与分词器和设置有关）。对分词进行搜索可能会包含很多无关内容，比如其他品牌的手机和真正的苹果。如果禁止分词，搜索苹果的时候可能不会出现苹果手机。

分词时覆盖度和准确度都是需要考虑的。

#### 2.标准化
为了搜索更准确，更接近人的思维，倒排索引还有一个同义词、相似词的问题。
- 相同的词：马斯克、MUSK、musk其实是一个意思
- 相似的词：dog和dogs是相似的，拥有同样的词根
- 同义词：工资和薪水看似不是同一个词，但是表达的意思是一样的

如果想根据人的思维模式，返回更符合预期的内容，就需要将词条规范为标准模式，这样就能查询到，与用户搜索的词条不完全一致的结果，但具有很强的相关性。

#### 3. 分词器
为了使查询更加智能，就需要进行分词和标准化处理，分词和标准化的过程称为分析。

分析是由ES中的分词器完成的，针对不通的场景（比如中文和英文）会有不同的分词器。